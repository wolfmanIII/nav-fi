# Feasibility Study: The Cube (TravellerMap Contract Broker)

> **Ambito**: Design Memo. Specifica i requisiti e l'architettura del futuro modulo "Contract Broker", definendo i principi di design e i limiti operativi.

## Design Philosophy: "The Hard Deck" (Guardrails & Determinism)

The Cube è un generatore di contenuto che impatta l'economia di gioco. Per evitare di rompere il bilanciamento della campagna o introdurre complessità ingestibile, il sistema segue questi principi non negoziabili:

### 1. Determinismo come Default
Ogni `BrokerSession` possiede un **Seed** fisso.
- A parità di Sector Data e Seed, la sequenza di generazione è identica.
- Questo garantisce testabilità, debuggabilità e previene il "save scumming" disonesto, ma permette il "replay" legittimo di una sessione tecnica.

### 2. Economia con Guardrail
I payout non sono "magia random", ma formule leggibili e controllate.
- **Formula Pubblica**: `BaseAmount * DistanceMult * RiskFactor + Bonus`.
- **Clamping**: Ogni valore ha un `MIN` e un `MAX` hardcodato per categoria (es. Freight non può pagare più di X Cr/ton).
- **Graceful Degradation**: Se i dati TravellerMap sono sporchi (es. manca UWP o Trade Code), il sistema non crasha ma usa valori di fallback conservativi (Low Payout).

### 3. Conversione Pulita (No Surprises)
- Il passaggio `BrokerOpportunity` -> `Income` è una trasformazione rigorosa.
- L'entità `Income` generata è indistinguibile da una creata a mano: categorie corrette (FREIGHT, PASSENGERS, MAIL), status `Draft`, date coerenti.
- Nessun dato "speciale" o "magico" nel JSON che alteri il comportamento del Ledger.

## Strategia Tecnica: "Local-First & Session"

### 1. Gestione Dati Settore (Disciplinata)
I dati dei settori vengono scaricati e versionati localmente.
- **Path**: `/data/sectors/{SectorName}_{Year}-{Month}.tab` (Naming normalizzato).
- **Locking**: Meccanismo di lock per evitare download concorrenti dello stesso settore.
- **Fallback**: Se il parser fallisce su una riga (dato corrotto), la riga viene saltata e loggata, senza fermare l'import.

### 2. Il concetto di "Broker Session"
La generazione è incapsulata in una sessione persistente.

**Flusso Operativo (MVP):**
1.  **Setup**: L'Arbitro crea sessione con seed (auto o manuale), *Settore*, *Origine*, *Range*.
2.  **Generate**: Il Cubo usa il seed per estrarre 5 candidate (ignorando i dati sporchi).
3.  **Selection**: L'Arbitro clicca "Keep" su quelle valide.
    - Le opportunità salvate vengono persistite su DB.
4.  **Convert**: "Accetta" un'opportunità salvata -> Crea `Income`. Fine.

*Funzioni avanzate (Mission Board UI, Publish) rimandate post-MVP.*

## Architettura Software

### Entità
1.  **`BrokerSession`**:
    - `id`, `campaign_id`
    - `sector` (string), `originHex` (string), `range` (int)
    - `status` (Draft, Published, Archived)
    - `createdAt`
2.  **`BrokerOpportunity`**:
    - `id`, `session_id`
    - `summary` (string), `amount` (decimal)
    - `data` (JSON: details, cargo type, route complexity)
    - `status` (Proposed, Saved, Converted)

### Servizi
1.  **`TravellerMapSectorLookup` (Evolved)**:
    - Attualmente gestisce lookup effimeri.
    - Verrà esteso per gestire download/persistenza dei file `.tab` (sostituendo la cache semplice con storage su file versionati).
    - Servirà sia il modulo Route (lookup singolo) sia The Cube (batch generation).
2.  **`TheCubeEngine`**: Logica di business per generare opportunità casuali basate sui Trade Codes.
3.  **`BrokerService`**: Gestisce il flusso sessione (save opportunity, convert to income).

## Esempio Interfaccia (Mockup)
- **Top Bar**: "Session: Spinward Marches @ 1910 [3/10 Saved]"
- **Left Col (The Stream)**: Nuove card generate. Bottoni: [Relay to Storage] [Discard].
- **Right Col (Storage)**: Lista contratti salvati.

## Esempio di Payload Generato
```json
{
  "type": "FREIGHT",
  "title": "Cryo-Storage Units to Rhylanor",
  "amount": 45000,
  "destination": "Rhylanor (2716)",
  "distance": 3,
  "cargo": {
      "tons": 15,
      "type": "Machinery"
  },
  "flavour": "Generated by The Cube based on [In] Industrial trade flow."
}
```

## Prossimi Passi (POC)
1.  Estendere l'esistente `TravellerMapSectorLookup` (o creare wrapper dedicato) per testare il download/parsing di "Spinward Marches".
2.  Implementare la formula della distanza esagonale (riusando `RouteMathHelper`).
3.  Creare un comando CLI `app:cube:test <sector> <hex> <range>` per verificare l'output JSON.
