# Feasibility Study: The Cube (TravellerMap Contract Broker)

## Obiettivo
Implementare un "Motore di Generazione Contratti" (The Cube) che, dato un input (Settore, Sistema di Partenza, Raggio in Parsec), interroghi **TravellerMap**, recuperi i sistemi vicini e generi automaticamente opportunità di **Income** (Freight, Passengers, Mail, Charter) coerenti con la lore.

## Strategia Tecnica: "Local-First & Session"

### 1. Gestione Dati Settore (Minimizzare API Calls)
Per evitare dipendenza diretta e latenza, i dati dei settori verranno scaricati e versionati localmente.
- **Cartella Dati**: `/data/sectors/{SectorName}_{Year}-{Month}.tab`
- **Logica**: Il sistema controlla se esiste un file locale valido per il mese corrente.
    - *Se esiste*: Usa il file locale.
    - *Se manca/vecchio*: Scarica da `travellermap.com/data/.../tab`, salva su disco e usa quello.
- **Vantaggio**: Resilienza offline, velocità in fase di generazione e rispetto dei rate limit API.

### 2. Il concetto di "Broker Session"
La generazione non è "usa e getta" ma una sessione di lavoro persistente.

**Flusso Operativo:**
1.  **Setup**: L'Arbitro avvia una sessione indicando *Settore*, *Origine*, *Range*.
2.  **Generate**: Il Cubo propone un batch (es. 5) di opportunità casuali.
3.  **Selection**: L'Arbitro seleziona quelle interessanti ("Keep").
    - Le opportunità salvate vengono persistite nel DB collegate alla Sessione.
    - Le scartate svaniscono.
4.  **Iterate**: Si possono generare altri batch finché non si raggiunge il "Cap" della sessione (es. 10 contratti salvati).
5.  **Terminal View**: La sessione finalizzata diventa un'interfaccia "Mission Board" da mostrare ai giocatori.
6.  **Accept**: Quando i giocatori accettano un contratto, questo viene convertito in una vera entità `Income`.

## Architettura Software

### Entità
1.  **`BrokerSession`**:
    - `id`, `campaign_id`
    - `sector` (string), `originHex` (string), `range` (int)
    - `status` (Draft, Published, Archived)
    - `createdAt`
2.  **`BrokerOpportunity`**:
    - `id`, `session_id`
    - `summary` (string), `amount` (decimal)
    - `data` (JSON: details, cargo type, route complexity)
    - `status` (Proposed, Saved, Converted)

### Servizi
1.  **`SectorDataManager`**: Gestisce download, caching e parsing dei file `.tab`.
2.  **`TheCubeEngine`**: Logica di business per generare opportunità casuali basate sui Trade Codes.
3.  **`BrokerService`**: Gestisce il flusso sessione (save opportunity, convert to income).

## Esempio Interfaccia (Mockup)
- **Top Bar**: "Session: Spinward Marches @ 1910 [3/10 Saved]"
- **Left Col (The Stream)**: Nuove card generate. Bottoni: [Relay to Storage] [Discard].
- **Right Col (Storage)**: Lista contratti salvati.

## Esempio di Payload Generato
```json
{
  "type": "FREIGHT",
  "title": "Cryo-Storage Units to Rhylanor",
  "amount": 45000,
  "destination": "Rhylanor (2716)",
  "distance": 3,
  "cargo": {
      "tons": 15,
      "type": "Machinery"
  },
  "flavour": "Generated by The Cube based on [In] Industrial trade flow."
}
```

## Prossimi Passi (POC)
1.  Creare `TravellerMapService` e testare il download/parsing di "Spinward Marches".
2.  Implementare la formula della distanza esagonale.
3.  Creare un comando CLI `app:cube:test <sector> <hex> <range>` per verificare l'output JSON.
