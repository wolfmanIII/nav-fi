{% import _self as detailsMacros %}

{% macro render_item(child) %}
    <div class="grid grid-cols-3 gap-2 border border-base-300 rounded p-3 relative collection-item bg-base-100">
        <button type="button" class="btn btn-ghost btn-xs absolute right-1 top-1" data-collection-remove>&times;</button>
        <div>
            {{ form_label(child.description) }}
            {{ form_widget(child.description) }}
            {{ form_errors(child.description) }}
        </div>
        <div>
            {{ form_label(child.tons) }}
            {{ form_widget(child.tons) }}
            {{ form_errors(child.tons) }}
        </div>
        <div>
            {{ form_label(child.costMcr) }}
            {{ form_widget(child.costMcr) }}
            {{ form_errors(child.costMcr) }}
        </div>
    </div>
{% endmacro %}

{% macro render_collection(collection, title) %}
    <div class="space-y-2" data-collection>
        <div class="flex items-center justify-between">
            <h4 class="font-semibold text-cyan-100">{{ title }}</h4>
            <button type="button" class="btn btn-outline btn-xs" data-collection-add>+ Add</button>
        </div>
        <div class="space-y-2" data-collection-list>
            {% for child in collection %}
                {{ _self.render_item(child) }}
            {% endfor %}
        </div>
        <template data-collection-prototype>
            {{ _self.render_item(collection.vars.prototype) }}
        </template>
    </div>
{% endmacro %}

<fieldset class="fieldset grid grid-cols-2 bg-base-200 border-base-300 gap-4 p-4 border rounded w-250">
    <legend class="fieldset-legend">Ship Details</legend>
    <div class="col-span-2">
        <div class="alert alert-info flex items-start gap-2">
            <div class="pt-0.5">
                {% include 'icons/radar.html.twig' %}
            </div>
            <div>
                Total Cost is auto-calculated and stored with the ship details, but it does not affect the Ship Price field: set your ship price independently.
            </div>
        </div>
    </div>
    <div class="col-span-2">
        <div class="relative overflow-hidden rounded-xl border border-cyan-500/30 bg-gradient-to-r from-slate-900 via-slate-800 to-cyan-900 shadow-lg mb-4">
            <div class="absolute inset-0 opacity-30 mix-blend-screen pointer-events-none"
                 style="background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.25), transparent 35%), radial-gradient(circle at 80% 30%, rgba(14,165,233,0.25), transparent 35%);">
            </div>
            <div class="relative p-4 flex items-start gap-3">
                <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/40">
                    {% include 'icons/ship-components.html.twig' %}
                </div>
                <div>
                    <p class="uppercase text-xs tracking-[0.25em] text-cyan-300/70">Ship details</p>
                    <h3 class="font-semibold text-cyan-100 text-xl leading-tight">Layout & components</h3>
                    <p class="text-sm text-cyan-100/80">Insert hull, drives, systems and payload in a structured way; data will be stored as JSON.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-span-2 grid grid-cols-3 gap-4">
        <div>
            {{ form_label(detailsForm.techLevel) }}
            {{ form_widget(detailsForm.techLevel) }}
            {{ form_errors(detailsForm.techLevel) }}
        </div>
        <div>
            {{ form_label(detailsForm.totalCost) }}
            <input type="text"
                   class="input m-1 w-full bg-base-200 text-base-content"
                   data-total-cost-display
                   readonly
                   value="—">
            {{ form_errors(detailsForm.totalCost) }}
            {{ form_widget(detailsForm.totalCost, { attr: { class: 'hidden' } }) }}
        </div>
    </div>

    {% set single_items = [
        { child: detailsForm.hull, label: 'Hull' },
        { child: detailsForm.mDrive, label: 'M-Drive' },
        { child: detailsForm.jDrive, label: 'J-Drive' },
        { child: detailsForm.powerPlant, label: 'Power Plant' },
        { child: detailsForm.fuel, label: 'Fuel Tanks' },
        { child: detailsForm.bridge, label: 'Bridge' },
        { child: detailsForm.computer, label: 'Computer' },
        { child: detailsForm.sensors, label: 'Sensors' },
        { child: detailsForm.commonAreas, label: 'Common Areas' },
        { child: detailsForm.cargo, label: 'Cargo' },
    ] %}

    <div class="col-span-2 grid grid-cols-3 gap-4">
        {% for item in single_items %}
            <div class="border border-base-300 rounded p-3 bg-base-100">
                <div class="flex items-center gap-1 mb-1">
                    <span class="font-semibold">{{ item.label }}</span>
                </div>
                <div>
                    {{ form_label(item.child.description) }}
                    {{ form_widget(item.child.description) }}
                    {{ form_errors(item.child.description) }}
                </div>
                {% set has_drive_extra = item.child.thrust is defined or item.child.jump is defined %}
                <div class="grid gap-2 mt-2 {{ has_drive_extra ? 'grid-cols-3' : 'grid-cols-2' }}">
                    {% if item.child.thrust is defined %}
                        <div>
                            {{ form_label(item.child.thrust) }}
                            {{ form_widget(item.child.thrust) }}
                            {{ form_errors(item.child.thrust) }}
                        </div>
                    {% elseif item.child.jump is defined %}
                        <div>
                            {{ form_label(item.child.jump) }}
                            {{ form_widget(item.child.jump) }}
                            {{ form_errors(item.child.jump) }}
                        </div>
                    {% endif %}
                    <div>
                        {{ form_label(item.child.tons) }}
                        {{ form_widget(item.child.tons) }}
                        {{ form_errors(item.child.tons) }}
                    </div>
                    <div>
                        {{ form_label(item.child.costMcr) }}
                        {{ form_widget(item.child.costMcr) }}
                        {{ form_errors(item.child.costMcr) }}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="col-span-2 grid grid-cols-1 gap-6">
        {{ detailsMacros.render_collection(detailsForm.weapons, 'Weapons') }}
        {{ detailsMacros.render_collection(detailsForm.craft, 'Craft') }}
        {{ detailsMacros.render_collection(detailsForm.systems, 'Systems') }}
        {{ detailsMacros.render_collection(detailsForm.staterooms, 'Staterooms') }}
        {{ detailsMacros.render_collection(detailsForm.software, 'Software') }}
    </div>
</fieldset>

<script>
(function() {
    const initCollections = () => {
        document.querySelectorAll('[data-collection]').forEach(section => {
            const list = section.querySelector('[data-collection-list]');
            const templateEl = section.querySelector('template[data-collection-prototype]');
            const addBtn = section.querySelector('[data-collection-add]');
            if (!templateEl || !list) {
                return;
            }
            const addItem = () => {
                const index = list.children.length;
                const html = templateEl.innerHTML.replace(/__name__/g, index);
                const wrapper = document.createElement('div');
                wrapper.innerHTML = html.trim();
                const newItem = wrapper.firstElementChild;
                list.appendChild(newItem);
                recalcTotalCost();
            };
            if (addBtn) {
                addBtn.addEventListener('click', addItem);
            }
            list.addEventListener('click', (event) => {
                const btn = event.target.closest('[data-collection-remove]');
                if (btn) {
                    const item = btn.closest('.collection-item');
                    if (item) {
                        item.remove();
                        recalcTotalCost();
                    }
                }
            });
        });
    };
    const recalcTotalCost = () => {
        const totalInput = document.querySelector('input[name$="[totalCost]"]');
        const totalDisplay = document.querySelector('[data-total-cost-display]');
        if (!totalInput) {
            return;
        }
        const costFields = document.querySelectorAll('[data-cost-mcr]');
        let sum = 0;
        costFields.forEach((input) => {
            const raw = (input.value || '').trim();
            if (!raw) {
                return;
            }
            // support both dot and comma decimals
            const val = parseFloat(raw.replace(',', '.'));
            if (!Number.isNaN(val)) {
                sum += val;
            }
        });
        totalInput.value = sum ? sum.toFixed(2) : '';
        if (totalDisplay) {
            if (sum) {
                const locale = document.documentElement.lang || navigator.language || 'en';
                totalDisplay.value = sum.toLocaleString(locale, {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                });
            } else {
                totalDisplay.value = '—';
            }
        }
    };
    const initCostListeners = () => {
        document.querySelectorAll('[data-cost-mcr]').forEach((input) => {
            input.addEventListener('input', recalcTotalCost);
            input.addEventListener('change', recalcTotalCost);
        });
        recalcTotalCost();
    };
    const initAll = () => {
        initCollections();
        initCostListeners();
    };
    document.addEventListener('DOMContentLoaded', initAll);
    document.addEventListener('turbo:load', initAll);
})();
</script>
