{% extends 'base.html.twig' %}

{% block title %}Nav-Fi&sup3; - Transaction Ledger{% endblock %}

{% import '_tooltip.html.twig' as tooltip %}

{% block pageContent %}
    <div class="p-10">

        {# ASSET HEADER (Reused style) #}
        {# ASSET HEADER (Reused style) #}
        {% set theme = asset.category == 'base' ? 'amber' : (asset.category == 'team' ? 'emerald' : 'cyan') %}
        <div class="relative rounded-2xl bg-slate-950 border border-slate-800 shadow-lg mb-6">
            <div class="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    {% include 'icons/handbook.html.twig' with { dim: 128, class: 'text-' ~ theme ~ '-500' } %}
                </div>
            </div>
            <div class="relative z-10 p-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                     <div class="flex items-center gap-2 text-{{ theme }}-500/80 mb-1">
                        {% include 'icons/handbook.html.twig' with { dim: 16 } %}
                        <p class="text-xs uppercase tracking-[0.3em] font-orbitron font-bold">Financial Ledger // Audit</p>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight flex items-center gap-3 font-orbitron">
                        {{ asset.name }}
                        <span class="text-xs align-top opacity-50 font-mono pt-2 normal-case tracking-normal text-slate-400">
                            // {{ asset.code }}
                        </span>
                    </h1>
                     <p class="text-xs text-slate-500 font-mono uppercase tracking-wider mt-1">
                        Transaction history and financial audit logs.
                    </p>
                </div>
                <div>
                     <a href="{{ path('app_asset_edit', { id: asset.id }) }}" class="btn btn-outline btn-sm gap-2 font-orbitron text-[10px] tracking-widest uppercase">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                        Back to Asset
                    </a>
                </div>
            </div>
        </div>

        {# LEDGER TABLE #}
        <div class="overflow-x-auto rounded-xl border border-slate-800 bg-slate-950/40 shadow-inner">
            <table class="table table-sm w-full border-separate border-spacing-0">
                <thead>
                <tr class="border-b border-slate-800 bg-slate-900/50">
                    <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 py-3">Effective Date</th>
                    <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 py-3">Recorded</th>
                    <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 py-3">Description</th>
                    <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 py-3 text-right">Amount</th>
                    <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 py-3 text-center">Status</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-slate-800/50">
                {% if transactions|length > 0 %}
                    {% for transaction in transactions %}
                        {% set is_void = transaction.status == constant('App\\Entity\\Transaction::STATUS_VOID') %}
                        <tr class="hover:bg-cyan-500/5 transition-colors group {% if is_void %}bg-rose-500/5{% endif %}">
                            {# Effective Date #}
                            <td class="font-mono text-xs p-3 align-top whitespace-nowrap {% if is_void %}line-through text-slate-500{% endif %}">
                                <span class="font-bold {% if is_void %}text-slate-500{% else %}text-slate-200{% endif %}">
                                    {{ transaction.sessionDay|imperial_date(transaction.sessionYear) }}
                                </span>
                            </td>

                            {# Recorded At #}
                             <td class="font-mono text-[10px] p-3 align-top text-slate-500 whitespace-nowrap">
                                {{ transaction.createdAt|date('Y-m-d H:i') }}
                            </td>

                            {# Description #}
                            <td class="text-sm p-3 align-top text-slate-300 {% if is_void %}line-through text-slate-500{% endif %}">
                                <div class="font-medium">{{ transaction.description }}</div>
                                {% if transaction.relatedEntityType %}
                                    <div class="text-[10px] uppercase tracking-wider text-slate-500 mt-1">
                                        Ref: {{ transaction.relatedEntityType|split('\\')|last }} #{{ transaction.relatedEntityId }}
                                    </div>
                                {% endif %}
                            </td>

                            {# Amount #}
                            <td class="font-mono text-sm p-3 align-top text-right font-bold {% if is_void %}line-through text-slate-600{% endif %}">
                                {% if transaction.amount > 0 %}
                                    <span class="{% if is_void %}text-rose-900/40{% else %}text-emerald-400{% endif %}">+{{ transaction.amount|number_format(0, '.', ',') }}</span>
                                {% elseif transaction.amount < 0 %}
                                    <span class="{% if is_void %}text-rose-900/40{% else %}text-red-400{% endif %}">{{ transaction.amount|number_format(0, '.', ',') }}</span>
                                {% else %}
                                    <span class="text-slate-500">0</span>
                                {% endif %}
                            </td>

                            {# Status #}
                            <td class="p-3 align-top text-center">
                                {% if transaction.status == constant('App\\Entity\\Transaction::STATUS_POSTED') %}
                                    <span class="badge badge-xs badge-success gap-1 bg-emerald-500/10 text-emerald-400 border-emerald-500/20">
                                        POSTED
                                    </span>
                                {% elseif transaction.status == constant('App\\Entity\\Transaction::STATUS_VOID') %}
                                    <span class="badge badge-xs badge-error gap-1 bg-rose-500/10 text-rose-400 border-rose-500/20">
                                        VOID
                                    </span>
                                {% else %}
                                    <div class="tooltip tooltip-left" data-tip="CAUSALITY LOCKED. Effective upon Temporal Cursor arrival.">
                                        <span class="badge badge-xs badge-warning gap-1 bg-amber-500/10 text-amber-400 border-amber-500/20 cursor-help font-rajdhani tracking-widest font-bold">
                                            LOCKED
                                        </span>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-xs text-slate-500 font-rajdhani uppercase tracking-widest py-12">
                            No financial history found.
                        </td>
                    </tr>
                {% endif %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-4">
             {% include 'components/pagination.html.twig' with {
                pagination: pagination,
                route: 'app_asset_ledger',
                route_params: { id: asset.id }
            } %}
        </div>

    </div>
{% endblock %}
