{% import _self as detailsMacros %}

{% macro render_item(child) %}
    <div class="grid grid-cols-3 gap-4 border border-slate-700 bg-slate-950/40 rounded-lg p-4 relative collection-item group hover:border-cyan-500/30 transition-colors">
        <button type="button"
                class="absolute -right-2 -top-2 w-6 h-6 rounded-full bg-slate-800 border border-slate-700 text-slate-400 hover:text-red-400 hover:border-red-500/50 flex items-center justify-center transition-all shadow-lg z-10"
                data-action="asset-details#removeItem">&times;</button>
        <div>
            <div class="flex items-baseline h-5 mb-1">
                {{ form_label(child.description, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
            </div>
            {{ form_widget(child.description, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800 focus:border-cyan-500/50' } }) }}
            {{ form_errors(child.description) }}
        </div>
        <div>
            <div class="flex items-baseline h-5 mb-1">
                {{ form_label(child.tons, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
            </div>
            {{ form_widget(child.tons, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800 focus:border-cyan-500/50' } }) }}
            {{ form_errors(child.tons) }}
        </div>
        <div>
            <div class="flex items-baseline h-5 mb-1">
                {{ form_label(child.costMcr, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
            </div>
            {{ form_widget(child.costMcr, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800 focus:border-cyan-500/50' } }) }}
            {{ form_errors(child.costMcr) }}
        </div>
    </div>
{% endmacro %}

{% macro render_collection(collection, title) %}
    <div class="grid grid-cols-1 gap-4" data-asset-details-target="collection">
        <div class="flex items-center justify-between">
            <h4 class="text-[10px] uppercase tracking-widest font-rajdhani font-bold text-slate-500">{{ title }}</h4>
            <button type="button" class="btn btn-outline btn-xs font-orbitron uppercase tracking-widest text-[9px]"
                    data-action="asset-details#addItem">+ Add Device</button>
        </div>
        <div class="space-y-4" data-asset-details-target="list">
            {% for child in collection %}
                {{ _self.render_item(child) }}
            {% endfor %}
        </div>
        <template data-asset-details-target="prototype">
            {{ _self.render_item(collection.vars.prototype) }}
        </template>
    </div>
{% endmacro %}

<fieldset class="grid grid-cols-2 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative"
         data-controller="asset-details">
    <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-cyan-500/80 uppercase">Asset technical details</legend>
    <div class="col-span-2">
        <div class="relative overflow-hidden rounded-xl border border-cyan-500/30 bg-gradient-to-r from-slate-900 via-slate-800 to-cyan-900 shadow-lg mb-4">
            <div class="absolute inset-0 opacity-30 mix-blend-screen pointer-events-none"
                 style="background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.25), transparent 35%), radial-gradient(circle at 80% 30%, rgba(14,165,233,0.25), transparent 35%);">
            </div>
            <div class="relative p-4 flex items-start gap-3">
                <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/40">
                    {% include 'icons/ship-components.html.twig' %}
                </div>
                <div>
                    <p class="uppercase text-xs tracking-[0.25em] text-cyan-300/70">Asset details</p>
                    <h3 class="font-semibold text-cyan-100 text-xl leading-tight">Layout & components</h3>
                    <p class="text-sm text-cyan-100/80">Insert hull, drives, systems and payload in a structured way; data will be stored as JSON.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-span-2">
        <div class="alert alert-info alert-outline border-cyan-500/50 bg-cyan-500/5 flex items-start gap-2">
            <div class="pt-0.5 animate-spin-slow text-cyan-500">
                {% include 'icons/radar.html.twig' with { dim: 16 } %}
            </div>
            <div class="text-xs font-rajdhani uppercase tracking-widest font-bold text-cyan-200">
                Total Cost is auto-calculated and stored with the asset details, but it does not affect the Asset Price field: set your asset price independently.
            </div>
        </div>
    </div>

    <div class="col-span-1 grid grid-cols-2 gap-4">
        <div class="col-span-1">
            <div class="flex items-baseline h-5 mb-1">
                {{ form_label(detailsForm.techLevel, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
            </div>
            {{ form_widget(detailsForm.techLevel, { attr: { class: 'select select-bordered select-sm w-full bg-slate-950/50 border-slate-800' } }) }}
            {{ form_errors(detailsForm.techLevel) }}
        </div>
        <div class="col-span-1">
            <div class="flex items-baseline h-5 mb-1">
                {{ form_label(detailsForm.totalCost, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
            </div>
            <input type="text"
                   class="input input-bordered input-sm w-full bg-slate-950/50 border-slate-800 font-mono text-cyan-400"
                   data-asset-details-target="totalDisplay"
                   readonly
                   value="">
            {{ form_widget(detailsForm.totalCost, { attr: { class: 'hidden', 'data-asset-details-target': 'totalInput' } }) }}
            {{ form_errors(detailsForm.totalCost) }}
        </div>
    </div>

    {% set single_items = [
        { child: detailsForm.hull, label: 'Hull' },
        { child: detailsForm.mDrive, label: 'M-Drive' },
        { child: detailsForm.jDrive, label: 'J-Drive' },
        { child: detailsForm.powerPlant, label: 'Power Plant' },
        { child: detailsForm.fuel, label: 'Fuel Tanks' },
        { child: detailsForm.bridge, label: 'Bridge' },
        { child: detailsForm.computer, label: 'Computer' },
        { child: detailsForm.sensors, label: 'Sensors' },
        { child: detailsForm.commonAreas, label: 'Common Areas' },
        { child: detailsForm.cargo, label: 'Cargo' },
    ] %}

    <div class="col-span-2 grid grid-cols-2 lg:grid-cols-3 gap-4">
        {% for item in single_items %}
            <div class="border border-slate-700 bg-slate-950/40 rounded-lg p-4 relative group hover:border-cyan-500/30 transition-colors">
                <div class="flex items-center gap-1 mb-2">
                    <span class="text-[10px] uppercase tracking-widest font-orbitron font-bold text-cyan-500/70">{{ item.label }}</span>
                </div>
                <div class="mb-3">
                    <div class="flex items-baseline h-5 mb-1">
                        {{ form_label(item.child.description, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                    </div>
                    {{ form_widget(item.child.description, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800 focus:border-cyan-500/50' } }) }}
                    {{ form_errors(item.child.description) }}
                </div>
                {% set has_drive_extra = item.child.thrust is defined or item.child.jump is defined or item.child.power is defined %}
                <div class="grid gap-2 {{ has_drive_extra ? 'grid-cols-3' : 'grid-cols-2' }}">
                    {% if item.child.thrust is defined %}
                        <div>
                            <div class="flex items-baseline h-5 mb-1">
                                {{ form_label(item.child.thrust, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                            </div>
                            {{ form_widget(item.child.thrust, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800' } }) }}
                            {{ form_errors(item.child.thrust) }}
                        </div>
                    {% elseif item.child.jump is defined %}
                        <div>
                            <div class="flex items-baseline h-5 mb-1">
                                {{ form_label(item.child.jump, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                            </div>
                            {{ form_widget(item.child.jump, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800' } }) }}
                            {{ form_errors(item.child.jump) }}
                        </div>
                    {% elseif item.child.power is defined %}
                        <div>
                            <div class="flex items-baseline h-5 mb-1">
                                {{ form_label(item.child.power, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                            </div>
                            {{ form_widget(item.child.power, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800' } }) }}
                            {{ form_errors(item.child.power) }}
                        </div>
                    {% endif %}
                    <div>
                        <div class="flex items-baseline h-5 mb-1">
                            {{ form_label(item.child.tons, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                        </div>
                        {{ form_widget(item.child.tons, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800' } }) }}
                        {{ form_errors(item.child.tons) }}
                    </div>
                    <div>
                        <div class="flex items-baseline h-5 mb-1">
                            {{ form_label(item.child.costMcr, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                        </div>
                        {{ form_widget(item.child.costMcr, { attr: { class: 'input input-bordered input-sm w-full bg-slate-950/50 border-slate-800' } }) }}
                        {{ form_errors(item.child.costMcr) }}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="col-span-2 grid grid-cols-1 gap-6">
        {{ detailsMacros.render_collection(detailsForm.weapons, 'Weapons') }}
        {{ detailsMacros.render_collection(detailsForm.craft, 'Craft') }}
        {{ detailsMacros.render_collection(detailsForm.systems, 'Systems') }}
        {{ detailsMacros.render_collection(detailsForm.staterooms, 'Staterooms') }}
        {{ detailsMacros.render_collection(detailsForm.software, 'Software') }}
    </div>
</fieldset>
