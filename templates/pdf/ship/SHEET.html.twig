{% extends 'base_plain.html.twig' %}

{% block title %}Ship Sheet{% endblock %}

{% block stylesheets %}
    <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; font-size: 10px; color: #0f172a; background: #ffffff; }
        .page { padding: 12px; }
        .header-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .header-table td { vertical-align: middle; }
        .logo { height: 64px; }
        .grid { display: grid; }
        .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
        .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
        .card { background: #f8fafc; border: none; border-radius: 10px; padding: 10px; margin-bottom: 10px; position: relative; overflow: hidden; page-break-inside: avoid; break-inside: avoid; }
        .card::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 15% 20%, rgba(59,130,246,0.08), transparent 40%), radial-gradient(circle at 75% 15%, rgba(14,165,233,0.1), transparent 35%); pointer-events: none; }
        .card > * { position: relative; z-index: 1; }
        .title { font-size: 16px; font-weight: 700; margin: 0 0 2px 0; color: #0f172a; letter-spacing: 0.02em; text-align: right; }
        .subtitle { font-size: 11px; text-transform: uppercase; letter-spacing: 0.2em; color: #475569; margin: 0; text-align: right; }
        .section-title { font-size: 12px; font-weight: 700; margin: 6px 0; color: #0f172a; }
        .table { width: 100%; border-collapse: collapse; font-size: 9px; }
        .table th, .table td { border: 1px solid #d1d5db; padding: 5px; vertical-align: top; }
        .table th { background: #e2e8f0; color: #0f172a; text-align: left; }
        .muted { color: #475569; font-size: 9px; }
        .value { font-weight: 600; color: #0f172a; }
        .summary { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 6px; margin-top: 8px; }
        .summary .item { background: transparent; border: none; border-radius: 8px; padding: 6px; }
        .summary .label { text-transform: uppercase; letter-spacing: 0.14em; font-size: 8px; color: #475569; }
        .summary .val { font-weight: 700; font-size: 11px; color: #0f172a; }
    </style>
{% endblock %}
{% block javascripts %}{% endblock %}

{% block pageContent %}
    {% set details = ship.shipDetails ?? {} %}
    {% set techLevel = details.techLevel ?? '—' %}
    {% set singleItems = [
        { label: 'Hull', item: details.hull ?? {}, spec: null, specLabel: null },
        { label: 'M-Drive', item: details.mDrive ?? {}, spec: details.mDrive.thrust ?? null, specLabel: 'Thrust' },
        { label: 'J-Drive', item: details.jDrive ?? {}, spec: details.jDrive.jump ?? null, specLabel: 'Jump' },
        { label: 'Power Plant', item: details.powerPlant ?? {}, spec: null, specLabel: null },
        { label: 'Fuel Tanks', item: details.fuel ?? {}, spec: null, specLabel: null },
        { label: 'Bridge', item: details.bridge ?? {}, spec: null, specLabel: null },
        { label: 'Computer', item: details.computer ?? {}, spec: null, specLabel: null },
        { label: 'Sensors', item: details.sensors ?? {}, spec: null, specLabel: null },
        { label: 'Common Areas', item: details.commonAreas ?? {}, spec: null, specLabel: null },
        { label: 'Cargo', item: details.cargo ?? {}, spec: null, specLabel: null },
    ] %}

    {% macro render_item(label, item, locale, spec, specLabel) %}
        {% set desc = item.description ?? '—' %}
        {% set costRaw = item.cost_mcr is defined ? item.cost_mcr : (item.costMcr is defined ? item.costMcr : null) %}
        {% set tons = item.tons is defined and item.tons is not null
            ? item.tons|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
            : '—' %}
        {% set cost = costRaw is not null
            ? costRaw|format_number({ min_fraction_digit: 3, max_fraction_digit: 3, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
            : '—' %}
        <tr>
            <th>{{ label }}</th>
            <td>{{ desc ?: '—' }}</td>
            <td style="text-align: right;">{{ tons }}</td>
            <td style="text-align: right;">{{ cost }}</td>
            <td>{{ spec is not null ? (specLabel is not null ? specLabel : label) ~ ' ' ~ spec : '—' }}</td>
        </tr>
    {% endmacro %}

    {% macro render_collection(title, items, locale) %}
        {% set rows = items|filter(i => (i.description ?? '') is not empty or (i.tons ?? null) is not null or (i.cost_mcr ?? null) is not null or (i.costMcr ?? null) is not null) %}
        {% set rows = rows|length == 0 ? items : rows %}
        {% set rows = rows|length == 0 ? [ {} ] : rows %}
        <div class="card">
            <div class="section-title">{{ title }}</div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Tons</th>
                        <th>Cost (MCr)</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in rows %}
                    {% set desc = row.description ?? '—' %}
                    {% set costRaw = row.cost_mcr is defined ? row.cost_mcr : (row.costMcr is defined ? row.costMcr : null) %}
                    {% set tons = row.tons is defined and row.tons is not null
                        ? row.tons|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
                        : '—' %}
                    {% set cost = costRaw is not null
                        ? costRaw|format_number({ min_fraction_digit: 3, max_fraction_digit: 3, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
                        : '—' %}
                    <tr>
                        <td>{{ desc ?: '—' }}</td>
                        <td style="text-align: right;">{{ tons }}</td>
                        <td style="text-align: right;">{{ cost }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% endmacro %}

    {% set totalCostMcr = 0 %}
    {% for entry in singleItems %}
        {% set c = entry.item.cost_mcr is defined ? entry.item.cost_mcr : (entry.item.costMcr is defined ? entry.item.costMcr : null) %}
        {% if c is not null %}
            {% set totalCostMcr = totalCostMcr + c %}
        {% endif %}
    {% endfor %}
    {% for row in details.weapons ?? [] %}
        {% set c = row.cost_mcr is defined ? row.cost_mcr : (row.costMcr is defined ? row.costMcr : null) %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.craft ?? [] %}
        {% set c = row.cost_mcr is defined ? row.cost_mcr : (row.costMcr is defined ? row.costMcr : null) %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.systems ?? [] %}
        {% set c = row.cost_mcr is defined ? row.cost_mcr : (row.costMcr is defined ? row.costMcr : null) %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.staterooms ?? [] %}
        {% set c = row.cost_mcr is defined ? row.cost_mcr : (row.costMcr is defined ? row.costMcr : null) %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.software ?? [] %}
        {% set c = row.cost_mcr is defined ? row.cost_mcr : (row.costMcr is defined ? row.costMcr : null) %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}

    <div class="page">
        <table class="header-table">
            <tr>
                <td style="text-align: left; width: 40%;">
                    <img src="{{ absolute_url(asset('img/captain-log-logo.png')) }}" alt="Captain Log" class="logo">
                </td>
                <td style="text-align: right; width: 60%;">
                    <div class="subtitle">Ship sheet</div>
                    <div class="title">Captain Log — {{ ship.name }}</div>
                </td>
            </tr>
        </table>

        <div class="card" style="margin-bottom: 12px;">
            <div class="summary">
                <div class="item">
                    <div class="label">Code</div>
                    <div class="val">{{ ship.code }}</div>
                </div>
                <div class="item">
                    <div class="label">Class / Type</div>
                    <div class="val">{{ ship.class }} — {{ ship.type }}</div>
                </div>
                <div class="item">
                    <div class="label">Campaign</div>
                    <div class="val">{{ ship.campaign ? ship.campaign.title : '—' }}</div>
                </div>
                <div class="item">
                    <div class="label">Price (Cr)</div>
                    <div class="val">{{ ship.price is not null
                        ? ship.price|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
                        : '—' }}</div>
                </div>
                {% set sessionDay = ship.campaign ? ship.campaign.sessionDay : ship.sessionDay %}
                {% set sessionYear = ship.campaign ? ship.campaign.sessionYear : ship.sessionYear %}
                <div class="item">
                    <div class="label">Session</div>
                    <div class="val">
                        {% if sessionDay or sessionYear %}
                            Day {{ sessionDay ?: '—' }} / {{ sessionYear ?: '—' }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
                <div class="item">
                    <div class="label">Tech level</div>
                    <div class="val">{{ techLevel }}</div>
                </div>
                <div class="item">
                    <div class="label">Total cost (MCr)</div>
                    <div class="val">
                        {% if totalCostMcr %}
                            {{ totalCostMcr|format_number({ min_fraction_digit: 3, max_fraction_digit: 3, grouping_used: true }, 'decimal', 'default', locale ?? 'en') }}
                        {% else %}
                            —
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">Core Systems & Layout</div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Description</th>
                        <th style="text-align: right;">Tons</th>
                        <th style="text-align: right;">Cost (MCr)</th>
                        <th>Spec</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in singleItems %}
                        {{ _self.render_item(entry.label, entry.item, locale, entry.spec, entry.specLabel) }}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="grid grid-2">
            {{ _self.render_collection('Weapons', details.weapons ?? [], locale) }}
            {{ _self.render_collection('Craft', details.craft ?? [], locale) }}
            {{ _self.render_collection('Systems', details.systems ?? [], locale) }}
            {{ _self.render_collection('Staterooms', details.staterooms ?? [], locale) }}
            {{ _self.render_collection('Software', details.software ?? [], locale) }}
        </div>
    </div>
{% endblock %}
