{% extends 'pdf/base_pdf.html.twig' %}

{% block title %}Asset Sheet{% endblock %}

{% block document_content %}
    {% set details = asset.assetDetails ?? {} %}
    {% set amendments = asset.amendments ?? [] %}
    {% set techLevel = details.techLevel ?? '—' %}
    {% set singleItems = [
        { label: 'Hull', item: details.hull ?? {}, spec: null, specLabel: null },
        { label: 'M-Drive', item: details.mDrive ?? {}, spec: details.mDrive.thrust ?? null, specLabel: 'Thrust' },
        { label: 'J-Drive', item: details.jDrive ?? {}, spec: details.jDrive.jump ?? null, specLabel: 'Jump' },
        { label: 'Power Plant', item: details.powerPlant ?? {}, spec: details.powerPlant.power ?? null, specLabel: 'Power' },
        { label: 'Fuel Tanks', item: details.fuel ?? {}, spec: null, specLabel: null },
        { label: 'Bridge', item: details.bridge ?? {}, spec: null, specLabel: null },
        { label: 'Computer', item: details.computer ?? {}, spec: null, specLabel: null },
        { label: 'Sensors', item: details.sensors ?? {}, spec: null, specLabel: null },
        { label: 'Common Areas', item: details.commonAreas ?? {}, spec: null, specLabel: null },
        { label: 'Cargo', item: details.cargo ?? {}, spec: null, specLabel: null },
    ] %}

    {% macro render_item(label, item, locale, spec, specLabel) %}
        {% set desc = item.description ?? '—' %}
        {% set costRaw = item.cost_mcr ?? item.costMcr ?? null %}
        {% set tons = (item.tons ?? null) is not null
            ? (item.tons ?? 0)|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
            : '—' %}
        {% set cost = costRaw is not null
            ? costRaw|format_number({ min_fraction_digit: 3, max_fraction_digit: 3, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
            : '—' %}
        <tr>
            <th>{{ label }}</th>
            <td>{{ desc ?: '—' }}</td>
            <td style="text-align: right;">{{ tons }}</td>
            <td style="text-align: right;">{{ cost }}</td>
            <td>{{ spec is not null ? (specLabel is not null ? specLabel : label) ~ ' ' ~ spec : '—' }}</td>
        </tr>
    {% endmacro %}

    {% macro render_collection(title, items, locale) %}
        {% set rows = items|filter(i => (i.description ?? '') is not empty or (i.tons ?? null) is not null or (i.cost_mcr ?? null) is not null or (i.costMcr ?? null) is not null) %}
        {% set rows = rows|length == 0 ? items : rows %}
        {% set rows = rows|length == 0 ? [ {} ] : rows %}
        <div class="card mb-4" style="page-break-inside: avoid;">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">{{ title }}</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Tons</th>
                            <th>Cost (MCr)</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in rows %}
                        {% set desc = row.description ?? '—' %}
                        {% set costRaw = row.cost_mcr ?? row.costMcr ?? null %}
                        {% set tons = (row.tons ?? null) is not null
                            ? (row.tons ?? 0)|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
                            : '—' %}
                        {% set cost = costRaw is not null
                            ? costRaw|format_number({ min_fraction_digit: 3, max_fraction_digit: 3, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
                            : '—' %}
                        <tr>
                            <td>{{ desc ?: '—' }}</td>
                            <td style="text-align: right;">{{ tons }}</td>
                            <td style="text-align: right;">{{ cost }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endmacro %}

    {% set totalCostMcr = 0 %}
    {% for entry in singleItems %}
        {% set c = entry.item.cost_mcr ?? entry.item.costMcr ?? null %}
        {% if c is not null %}
            {% set totalCostMcr = totalCostMcr + c %}
        {% endif %}
    {% endfor %}
    {% for row in details.weapons ?? [] %}
        {% set c = row.cost_mcr ?? row.costMcr ?? null %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.craft ?? [] %}
        {% set c = row.cost_mcr ?? row.costMcr ?? null %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.systems ?? [] %}
        {% set c = row.cost_mcr ?? row.costMcr ?? null %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.staterooms ?? [] %}
        {% set c = row.cost_mcr ?? row.costMcr ?? null %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}
    {% for row in details.software ?? [] %}
        {% set c = row.cost_mcr ?? row.costMcr ?? null %}
        {% if c is not null %}{% set totalCostMcr = totalCostMcr + c %}{% endif %}
    {% endfor %}

    <div class="mb-6">
        <table class="header-table">
            <tr>
                <td style="text-align: left; width: 40%;">
                    <img src="{{ asset_data_uri('img/nav-fi-logo.png') }}" alt="Nav-Fi&sup3;" class="logo">
                </td>
                <td style="text-align: right; width: 60%;">
                    <div class="text-xs uppercase tracking-widest text-gray-500">Asset sheet</div>
                    <div class="text-2xl font-bold text-gray-800">Nav-Fi&sup3; — {{ asset.name }}</div>
                    <div class="text-xs text-gray-500 mt-1">Template: {{ template_version('pdf/asset/SHEET.html.twig') }}</div>
                </td>
            </tr>
        </table>

        <div class="card mb-4">
            <div class="card-body p-4">
                {# Row 1: Code (Full Width) #}
                <div class="mb-4 border-b border-gray-200 pb-2">
                    <div class="text-xs uppercase tracking-widest text-gray-500">Code</div>
                    <div class="font-bold text-lg text-gray-800">{{ asset.code }}</div>
                </div>

                {# Row 2: Grid for other details #}
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <div class="text-xs uppercase tracking-widest text-gray-500">Class / Type</div>
                        <div class="font-bold text-sm text-gray-800">{{ asset.class }} — {{ asset.type }}</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase tracking-widest text-gray-500">Tech level</div>
                        <div class="font-bold text-sm text-gray-800">{{ techLevel }}</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase tracking-widest text-gray-500">Campaign</div>
                        <div class="font-bold text-sm text-gray-800">{{ asset.campaign ? asset.campaign.title : '—' }}</div>
                    </div>
                    
                    <div>
                        {% set sessionDay = asset.campaign ? asset.campaign.sessionDay : null %}
                        {% set sessionYear = asset.campaign ? asset.campaign.sessionYear : null %}
                        {% set sessionValue = (sessionDay is not null and sessionYear is not null) ? (sessionDay|imperial_date(sessionYear)) : '—' %}
                        <div class="text-xs uppercase tracking-widest text-gray-500">Session</div>
                        <div class="font-bold text-sm text-gray-800">
                            {{ sessionValue }}
                        </div>
                    </div>
                    <div>
                        <div class="text-xs uppercase tracking-widest text-gray-500">Price (Cr)</div>
                        <div class="font-bold text-sm text-gray-800">{{ asset.price is not null
                            ? asset.price|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale ?? 'en')
                            : '—' }}</div>
                    </div>
                    <div>
                        <div class="text-xs uppercase tracking-widest text-gray-500">Total cost (MCr)</div>
                        <div class="font-bold text-sm text-gray-800">
                            {% if totalCostMcr %}
                                {{ totalCostMcr|format_number({ min_fraction_digit: 3, max_fraction_digit: 3, grouping_used: true }, 'decimal', 'default', locale ?? 'en') }}
                            {% else %}
                                —
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 pt-0">
                <div class="text-xs text-gray-500" style="font-size: 8px;">
                     * Total Cost is auto-calculated and stored with the asset details, but it does not affect the Asset Price.
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">Core Systems & Layout</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Description</th>
                            <th style="text-align: right;">Tons</th>
                            <th style="text-align: right;">Cost (MCr)</th>
                            <th>Spec</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in singleItems %}
                            {{ _self.render_item(entry.label, entry.item, locale, entry.spec, entry.specLabel) }}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            {{ _self.render_collection('Weapons', details.weapons ?? [], locale) }}
            {{ _self.render_collection('Craft', details.craft ?? [], locale) }}
            {{ _self.render_collection('Systems', details.systems ?? [], locale) }}
            {{ _self.render_collection('Staterooms', details.staterooms ?? [], locale) }}
            {{ _self.render_collection('Software', details.software ?? [], locale) }}
        </div>

        {% if amendments|length > 0 %}
            <div class="card mb-4">
                <div class="card-body p-4">
                    <h2 class="card-title text-lg mb-2">Amendments Log</h2>
                    <table class="table text-sm">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Title</th>
                                <th>Effective date</th>
                                <th>Cost ref</th>
                                <th>Amount(Cr)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for amendment in amendments %}
                                <tr>
                                    <td>{{ amendment.code }}</td>
                                    <td>
                                        <div class="font-bold text-gray-800">{{ amendment.title }}</div>
                                        {% if amendment.description %}
                                            <div class="text-xs text-gray-500">{{ amendment.description }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ (amendment.effectiveDay is not null and amendment.effectiveYear is not null) ? (amendment.effectiveDay|imperial_date(amendment.effectiveYear)) : '—' }}
                                    </td>
                                    <td>
                                        {% if amendment.cost %}
                                            {{ amendment.cost.code }} — {{ amendment.cost.title }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if amendment.cost %}
                                            {{ amendment.cost.amount|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
