{% extends 'pdf/base_pdf.html.twig' %}

{% block title %}Asset Mortgage Agreement{% endblock %}

{% block document_content %}
    {% set locale = locale ?? 'en' %}
    {% set summary = mortgage.calculate() %}
    {% set installments = mortgage.mortgageInstallments %}
    {% set crew = asset.crews %}
    {% set filteredCrew = [] %}
    {% set captain = null %}
    {% for member in crew %}
        {% if captain is null and member.isCaptain() %}
            {% set captain = member %}
        {% endif %}
        {% if member.isVisibleInMortgage(mortgage.signingYear, mortgage.signingDay) %}
            {% set filteredCrew = filteredCrew|merge([member]) %}
        {% endif %}
    {% endfor %}

    <div class="mb-6">
        <table class="header-table">
            <tr>
                <td>
                    <img src="{{ asset_data_uri('img/nav-fi-logo.png') }}" alt="Nav-Fi&sup3;" class="logo">
                </td>
                <td class="text-right">
                    <div class="text-2xl font-bold">Asset Mortgage Agreement</div>
                    <div class="text-sm font-bold">
                        Code: {{ mortgage.code }}{% if mortgage.signed %} • Signed{% else %} • Pro forma draft{% endif %}
                    </div>
                    {% set sessionDay = asset.campaign ? asset.campaign.sessionDay : null %}
                    {% set sessionYear = asset.campaign ? asset.campaign.sessionYear : null %}
                    {% set sessionValue = (sessionDay is not null and sessionYear is not null) ? (sessionDay|imperial_date(sessionYear)) : '—' %}
                    <div class="text-sm">Generated on: {{ sessionValue }}</div>
                    <div class="text-sm">Template: {{ template_version('pdf/contracts/MORTGAGE.html.twig') }}</div>
                </td>
            </tr>
        </table>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">
                Local Law
            </h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th>Short Reference</th>
                        <th>Legal Basis / Article</th>
                        <th>Mandatory Disclaimer</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                    <td class="px-2">{{ mortgage.localLaw ? mortgage.localLaw.shortDescription : '—' }}</td>
                        <td class="px-2">{{ mortgage.localLaw ? mortgage.localLaw.description : '—' }}</td>
                        <td class="px-2">{{ mortgage.localLaw ? (mortgage.localLaw.disclaimer ?? '—') : '—' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Overview</h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Status</th>
                        <th class="text-left px-2">Start</th>
                        <th class="text-left px-2">Duration</th>
                        <th class="text-left px-2">Monthly total</th>
                        <th class="text-left px-2">Annual total</th>
                        <th class="text-left px-2">Company</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="px-2">{{ mortgage.signed ? 'Signed' : 'Pending' }}</td>
                        {% set startValue = (mortgage.startDay is not null and mortgage.startYear is not null) ? (mortgage.startDay|imperial_date(mortgage.startYear)) : '—' %}
                        <td class="px-2">{{ startValue }}</td>
                        <td class="px-2">{{ mortgage.interestRate.duration }} years</td>
                        <td class="text-right px-2">{{ summary.total_monthly_payment|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.total_annual_payment|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="px-2">
                            {% if mortgage.company %}
                                {{ mortgage.company.name }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Vessel</h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Name</th>
                        <th class="text-left px-2">Type / Class</th>
                        <th class="text-left px-2">Price</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="px-2">{{ asset.name }}</td>
                        <td class="px-2">{{ asset.type }} / {{ asset.class }}</td>
                        <td class="text-right px-2">{{ asset.price|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Counterparty</h2>
            {% if mortgage.company %}
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Name</th>
                            <th class="text-left px-2">Role</th>
                            <th class="text-left px-2">Contact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="px-2">{{ mortgage.company.name }}</td>
                            <td class="px-2">{{ mortgage.company.companyRole.description }}</td>
                            <td class="px-2">{{ mortgage.company.contact ?? '—' }}</td>
                        </tr>
                    </tbody>
                </table>
            {% else %}
                <p>Not specified</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Terms</h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Start</th>
                        <th class="text-left px-2">Asset Shares</th>
                        <th class="text-left px-2">Deposit</th>
                        <th class="text-right px-2">Discount</th>
                        <th class="text-left px-2">Interest</th>
                        <th class="text-left px-2">Insurance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% set startValue3 = (mortgage.startDay is not null and mortgage.startYear is not null) ? (mortgage.startDay|imperial_date(mortgage.startYear)) : '—' %}
                        <td class="px-2">{{ startValue3 }}</td>
                        <td class="px-2">{{ mortgage.assetShares ?? 0 }}</td>
                        <td class="text-right px-2">{{ mortgage.advancePayment|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ (mortgage.discount ?? 0)|format_number({ min_fraction_digit: 0, max_fraction_digit: 2 }, 'decimal', 'default', locale) }} %</td>
                        <td class="px-2">
                            {{ mortgage.interestRate.duration }} years,
                            x{{ mortgage.interestRate.priceMultiplier }}/{{ mortgage.interestRate.priceDivider }},
                            {{ mortgage.interestRate.annualInterestRate }}% annual
                        </td>
                        <td class="px-2">
                            {% if mortgage.insurance %}
                                {{ mortgage.insurance.name }} ({{ mortgage.insurance.annualCost }}% asset price)
                            {% else %}
                                None
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-3">Mortgage</h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Asset cost</th>
                        <th class="text-left px-2">Monthly</th>
                        <th class="text-left px-2">Annual</th>
                        <th class="text-left px-2">Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-right px-2">{{ summary.asset_cost|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.mortgage_monthly|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.mortgage_annual|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.total_mortgage|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-3">Insurance & totals</h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Ins. monthly</th>
                        <th class="text-left px-2">Ins. annual</th>
                        <th class="text-left px-2">Total monthly</th>
                        <th class="text-left px-2">Total annual</th>
                        <th class="text-left px-2">Paid (count)</th>
                        <th class="text-left px-2">Paid (Cr)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-right px-2">{{ summary.insurance_monthly|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.insurance_annual|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.total_monthly_payment|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.total_annual_payment|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                        <td class="text-right px-2">{{ summary.installments_paid }}</td>
                        <td class="text-right px-2">{{ summary.total_mortgage_paid|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    {% if installments|length > 0 %}
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Paid installments</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Code</th>
                            <th class="text-left px-2">Date</th>
                            <th class="text-right px-2">Amount (Cr)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inst in installments %}
                            <tr>
                                <td class="px-2">{{ inst.code }}</td>
                                {% set payVal = (inst.paymentDay is not null and inst.paymentYear is not null) ? (inst.paymentDay|imperial_date(inst.paymentYear)) : '—' %}
                                <td class="px-2">{{ payVal }}</td>
                                <td class="text-right px-2">{{ inst.payment|format_number({ min_fraction_digit: 2, max_fraction_digit: 2, grouping_used: true }, 'decimal', 'default', locale) }} Cr</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    {% if filteredCrew|length > 0 %}
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Asset crew</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Name</th>
                            <th class="text-left px-2">Surname</th>
                            <th class="text-left px-2">Callsign</th>
                            <th class="text-left px-2">Roles</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in filteredCrew %}
                            <tr>
                                <td class="px-2">{{ member.name }}</td>
                                <td class="px-2">{{ member.surname }}</td>
                                <td class="px-2">{{ member.nickname ?? '-' }}</td>
                                <td class="px-2">
                                    {% for role in member.assetRoles %}
                                        {{ role.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-body p-4">
            <table class="signature-table text-sm">
                <tr>
                    <td>
                        <div><b>Owner / Operator</b></div>
                        <div>
                            {% if captain %}
                                <i>{{ captain.name }} {{ captain.surname }}</i>
                            {% else %}
                                — 
                            {% endif %}
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <div><b>Signing location &amp; Date</b></div>
                        {% if mortgage.signed %}
                            {{ mortgage.signingLocation }} - {{ (mortgage.signingDay is not null and mortgage.signingYear is not null) ? (mortgage.signingDay|imperial_date(mortgage.signingYear)) : '—' }}
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        <div><b>Counterparty</b></div>
                        {% if mortgage.company %}
                            <div><i>{{ mortgage.company.signLabel ?? mortgage.company.name }}</i></div>
                        {% else %}
                            <div>_____________________</div>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>
{% endblock %}
