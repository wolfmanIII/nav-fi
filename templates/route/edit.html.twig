{% extends 'base.html.twig' %}

{% block title %}Nav-Fi&sup3; - Route{% endblock %}

{% block pageContent %}

    <div class="flex flex-col items-stretch gap-4">
        {{ form_start(form, { attr: { 'data-controller': 'form-visibility' } }) }}

        {% embed 'components/_hero_header.html.twig' with {
            icon: 'icons/routes.html.twig',
            theme: 'cyan',
            subheader: 'Cartography // Astrogation',
            title: 'FLIGHT PATH',
            titleSuffix: '// Navigation',
            description: 'Establish sectors, hex-coords and jump-logic: the map is NOT the territory.'
        } %}
            {% block actions %}
                {% import '_tooltip.html.twig' as tooltip %}
                <a href="{{ path('app_route_index') }}" class="btn btn-outline btn-sm gap-2 font-orbitron text-[10px] tracking-widest uppercase">
                    {% include 'icons/back.html.twig' %}
                </a>
                {% if route.id %}
                    {{ tooltip.link(
                        'Manage Waypoints & Details',
                        'Waypoints',
                        'icons/waypoint.html.twig',
                        path('app_route_details', {id: route.id}),
                        {
                            position: 'tooltip-bottom',
                            linkClass: 'btn btn-outline btn-sm gap-2 font-orbitron text-[10px] tracking-widest uppercase text-cyan-500 hover:text-cyan-400 border-cyan-500/50 hover:border-cyan-400'
                        }
                    ) }}
                {% endif %}
            {% endblock %}
        {% endembed %}

        <fieldset class="grid grid-cols-1 md:grid-cols-2 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-cyan-500/80 uppercase">Mission Context</legend>
            {% if form_errors(form) %}
                <div class="col-span-2">
                    <div class="alert alert-error alert-outline shadow-sm">
                        <div class="animate-spin-slow text-current">
                            {% include 'icons/radar.html.twig' with { dim: 24 } %}
                        </div>
                        <div class="text-sm text-slate-200">
                            {{ form_errors(form) }}
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if route.id %}
                <div class="col-span-2">
                    <div class="flex items-baseline h-5 mb-1">
                        <label class="block text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Route Code // Navigation ID</label>
                    </div>
                    <div class="px-3 py-2 rounded bg-slate-950/50 border border-slate-800 font-mono text-cyan-400 text-sm"><b>{{ route.code }}</b></div>
                </div>
            {% endif %}

            <div class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4" data-controller="campaign-asset">
                <div>
                    <div class="flex items-baseline h-5 mb-1">
                        {{ form_label(form.campaign, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                    </div>
                    {{ form_widget(form.campaign, { attr: { class: 'select select-bordered w-full bg-slate-950/50 border-slate-700' } }) }}
                    {{ form_errors(form.campaign) }}
                </div>
                <div>
                    <div class="flex items-baseline h-5 mb-1">
                        {{ form_label(form.asset, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                    </div>
                    {{ form_widget(form.asset, { attr: { class: 'select select-bordered w-full bg-slate-950/50 border-slate-700' } }) }}
                    {{ form_errors(form.asset) }}
                </div>
            </div>
        </fieldset>

        <div data-form-visibility-target="container" class="space-y-6">

        <turbo-frame id="route-ship-data">
        {% if form.shipHull is defined or form.shipJump is defined or form.shipFuel is defined %}
        <fieldset class="grid grid-cols-1 md:grid-cols-3 bg-red-900/10 border border-red-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative">
            <legend class="px-3 py-1 rounded bg-red-900/50 border border-red-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-red-400 uppercase">Missing Ship Data</legend>
            <div class="col-span-full mb-2 text-xs text-red-300">
                The selected ship is missing critical navigation data. Please provide it below to continue. This will update the ship's specifications.
            </div>
            
            {% if form.shipHull is defined %}
            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.shipHull, 'Ship Hull (dTons)', { label_attr: { class: 'mb-0 text-red-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-70' } }) }}
                </div>
                {{ form_widget(form.shipHull) }}
                {{ form_errors(form.shipHull) }}
                <div class="text-[10px] text-red-400/70 mt-1">{{ form_help(form.shipHull) }}</div>
            </div>
            {% endif %}
            
            {% if form.shipJump is defined %}
            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.shipJump, 'Ship Jump Rating', { label_attr: { class: 'mb-0 text-red-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-70' } }) }}
                </div>
                {{ form_widget(form.shipJump) }}
                {{ form_errors(form.shipJump) }}
                <div class="text-[10px] text-red-400/70 mt-1">{{ form_help(form.shipJump) }}</div>
            </div>
            {% endif %}

            {% if form.shipFuel is defined %}
            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.shipFuel, 'Ship Fuel Tank (tons)', { label_attr: { class: 'mb-0 text-red-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-70' } }) }}
                </div>
                {{ form_widget(form.shipFuel) }}
                {{ form_errors(form.shipFuel) }}
                <div class="text-[10px] text-red-400/70 mt-1">{{ form_help(form.shipFuel) }}</div>
            </div>
            {% endif %}
        </fieldset>
        {% endif %}
        </turbo-frame>

        <fieldset class="grid grid-cols-1 md:grid-cols-3 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-cyan-500/80 uppercase">Travel Data(Auto filled)</legend>

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.startDate, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.startDate) }}
            </div>
            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.destDate, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.destDate) }}
            </div>

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    <label class="mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Total Distance</label>
                </div>
                <input type="text" class="input input-bordered w-full bg-slate-950/50 border-slate-700 font-mono text-cyan-400 cursor-not-allowed" value="{{ form.vars.data.jumpDistance ?? '—' }} parsecs" readonly disabled>
            </div>
        </fieldset>

        <fieldset class="grid grid-cols-2 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative"
                  data-controller="dependent-select" 
                  data-dependent-select-url-value="{{ path('api_sector_worlds') }}">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-cyan-500/80 uppercase">Navigation Plan</legend>
            
            <div class="col-span-2">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.name, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.name, { attr: { class: 'input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50' } }) }}
                {{ form_errors(form.name) }}
            </div>

            <div class="col-span-2 grid grid-cols-2 gap-4 relative mb-4">
                {# Radar Overlay centered on the section #}
                <div class="loader-overlay">
                    <div class="radar-loader"></div>
                    <div class="radar-loader-label">SYNCING DATA</div>
                </div>
                <div class="col-span-1">
                    <div class="flex items-baseline h-5 mb-1">
                        {{ form_label(form.startSector, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                    </div>
                    {{ form_widget(form.startSector) }}
                    {{ form_errors(form.startSector) }}
                </div>
                <div class="col-span-1">
                    <div class="flex items-baseline h-5 mb-1">
                        {{ form_label(form.startWorld, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                    </div>
                    {{ form_widget(form.startWorld) }}
                    {{ form_errors(form.startWorld) }}
                </div>
                
                {# Constraints #}
                <div class="col-span-2 grid grid-cols-2 gap-4 mt-2">
                    <div class="form-control">
                        <label class="cursor-pointer label justify-start gap-4">
                            {{ form_widget(form.avoidRedZones) }}
                            <span class="label-text text-slate-300 font-orbitron text-[10px] uppercase tracking-wider font-bold">Avoid Red Zones</span>
                        </label>
                        <div class="text-[10px] text-slate-500 px-1">{{ form_help(form.avoidRedZones) }}</div>
                    </div>
                    <div class="form-control">
                        <label class="cursor-pointer label justify-start gap-4">
                            {{ form_widget(form.preferHighPort) }}
                            <span class="label-text text-slate-300 font-orbitron text-[10px] uppercase tracking-wider font-bold">Require Starport</span>
                        </label>
                         <div class="text-[10px] text-slate-500 px-1">{{ form_help(form.preferHighPort) }}</div>
                    </div>
                </div>
            </div>

            <div class="col-span-2">
                <div class="flex items-baseline h-5 mb-1">
                    <label class="mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Waypoints</label>
                </div>
            </div>

            <div class="col-span-2">
                <div class="overflow-x-auto flex-grow relative min-h-[200px] h-[200px]">
                    <table class="table table-sm w-full border-separate border-spacing-0">
                        <thead>
                        <tr class="border-b border-slate-800">
                            <th class="bg-slate-900/50 w-12"></th>
                            <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 bg-slate-900/50">#</th>
                            <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 bg-slate-900/50">Sector</th>
                            <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 bg-slate-900/50">World</th>
                            <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 bg-slate-900/50">Hex</th>
                            <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 bg-slate-900/50">UWP</th>
                            <th class="font-rajdhani uppercase tracking-widest text-[11px] text-slate-400 bg-slate-900/50 text-right">Distance(pc)</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800/50" data-route-waypoint-modal-target="tableBody">
                        {% if route.waypoints|length > 0 %}
                            {% for waypoint in route.waypoints %}
                                <tr class="hover:bg-emerald-500/5 transition-colors text-slate-300">
                                    <td class="text-center p-2">
                                    </td>
                                    <td class="font-mono text-xs p-2 text-slate-500">{{ waypoint.position }}</td>
                                    <td class="font-mono text-xs p-2">{{ waypoint.sector ?? '—' }}</td>
                                    {% set zone = world_zone(waypoint.sector, waypoint.hex) %}
                                    <td class="p-2">
                                        <span class="badge badge-sm font-mono font-bold {{ zone == 'R' ? 'badge-error text-white' : (zone == 'A' ? 'badge-warning text-black' : 'badge-ghost text-slate-300') }}">
                                            {{ waypoint.world ?? '—' }}
                                        </span>
                                    </td>
                                    <td class="font-mono text-xs p-2">{{ waypoint.hex }}</td>
                                    <td class="font-mono text-xs p-2">{{ waypoint.uwp ?? '—' }}</td>
                                    <td class="font-mono text-xs p-2 text-right text-emerald-300">{{ waypoint.jumpDistance ?? '—' }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr class="empty-row" data-route-waypoint-modal-target="emptyRow">
                                <td colspan="8" class="text-center text-slate-500 font-rajdhani uppercase tracking-widest text-xs py-8">
                                    // No waypoints mapped
                                </td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

        </fieldset>

        <fieldset class="grid grid-cols-1 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-slate-400 uppercase">Route Notes</legend>
            <div class="mb-4">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.description, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.description, { attr: { class: 'textarea textarea-bordered w-full bg-slate-950/50 border-slate-700 h-24 focus:border-cyan-500/50 font-rajdhani', placeholder: 'Dossier summary...' } }) }}
                {{ form_errors(form.description) }}
            </div>
            <div>
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.notes, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.notes, { attr: { class: 'textarea textarea-bordered textarea-sm w-full bg-slate-950/50 border-slate-700 h-20 focus:border-cyan-500/50 font-rajdhani', 'placeholder': 'Optional notes...' } }) }}
                {{ form_errors(form.notes) }}
            </div>
            
        </fieldset>

        <div class="flex items-center justify-end gap-3 mb-10">
            <a href="{{ path('app_route_index') }}" class="btn btn-ghost font-orbitron uppercase text-[10px] tracking-widest text-slate-500 hover:text-slate-300 font-bold">Abort Changes</a>
            <button type="submit"
                    class="btn btn-primary px-8 font-orbitron uppercase text-[10px] tracking-widest font-bold shadow-lg shadow-cyan-500/10"
            >
                Confirm Route // Commit to Log
            </button>
        </div>

        </div> 

        {{ form_end(form) }}
    </div>

{% endblock %}
