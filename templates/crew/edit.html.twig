{% extends 'base.html.twig' %}

{% set CAN_EDIT = constant('App\\Security\\Voter\\CrewVoter::EDIT') %}
{% set CAN_CREATE = constant('App\\Security\\Voter\\CrewVoter::CREATE') %}
{% set can_edit = is_granted(CAN_EDIT, crew) %}
{% set can_create = is_granted(CAN_CREATE, crew) %}

{% block title %}Nav-Fi - Crew{% endblock %}

{% block pageContent %}

    <div class="flex flex-col items-stretch gap-4">

        {{ form_start(form) }}

        {{ form_widget(form._token) }}

        <fieldset class="fieldset grid grid-cols-2 bg-base-200 border-base-300 gap-4 p-4 border rounded w-full">
            <legend class="fieldset-legend">Crew</legend>

            <div class="col-span-2">
                <div class="relative overflow-hidden rounded-xl border border-cyan-500/30 bg-gradient-to-r from-slate-900 via-slate-800 to-cyan-900 shadow-lg">
                    <div class="absolute inset-0 opacity-30 mix-blend-screen pointer-events-none"
                         style="background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.25), transparent 35%), radial-gradient(circle at 80% 30%, rgba(14,165,233,0.25), transparent 35%);">
                    </div>
                    <div class="relative p-4 flex items-start gap-3">
                        <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/40">
                            {% include 'icons/crew.html.twig' %}
                        </div>
                        <div>
                            <p class="uppercase text-xs tracking-[0.25em] text-cyan-300/70">Crew sheet</p>
                            <h3 class="font-semibold text-cyan-100 text-xl leading-tight">Bridge roles</h3>
                            <p class="text-sm text-cyan-100/80">Define bridge roles and captain before departure: the crew is the heart of your ship.</p>
                        </div>
                    </div>
                </div>
            </div>

            {% if crew.id %}
                <div class="col-span-2">
                    <label class="block text-slate-300">Code</label>
                    <div class="m-1 w-full"><b>{{ crew.code }}</b></div>
                </div>
            {% endif %}

            {% set statusHasErrors = form.status.vars.errors|length > 0 %}
            {% set dateErrorCount = 0 %}
            {% for dateField in ['activeDate', 'onLeaveDate', 'retiredDate', 'miaDate', 'deceasedDate'] %}
                {% set dateErrorCount = dateErrorCount + attribute(form, dateField).vars.errors|length %}
                {% set dateErrorCount = dateErrorCount + attribute(form, dateField).display.vars.errors|length %}
                {% set dateErrorCount = dateErrorCount + attribute(form, dateField).year.vars.errors|length %}
                {% set dateErrorCount = dateErrorCount + attribute(form, dateField).day.vars.errors|length %}
            {% endfor %}
            {% if statusHasErrors or dateErrorCount > 0 or form.vars.errors|length > 0 %}
                <div class="col-span-2">
                    <div class="alert alert-error alert-outline shadow-sm">
                        <span class="flex items-center justify-center animate-spin-slow">
                            {% include 'icons/radar.html.twig' %}
                        </span>
                        <div class="text-xs text-rose-100">
                            {{ form_errors(form) }}
                            {{ form_errors(form.status) }}
                            {% for dateField in ['activeDate', 'onLeaveDate', 'retiredDate', 'miaDate', 'deceasedDate'] %}
                                {{ form_errors(attribute(form, dateField)) }}
                                {{ form_errors(attribute(form, dateField).display) }}
                                {{ form_errors(attribute(form, dateField).year) }}
                                {{ form_errors(attribute(form, dateField).day) }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <div>
                {{ form_label(form.name) }}
                {{ form_widget(form.name) }}
                {{ form_errors(form.name) }}
            </div>

            <div>
                {{ form_label(form.surname) }}
                {{ form_widget(form.surname) }}
                {{ form_errors(form.surname) }}
            </div>

            <div>
                {{ form_label(form.nickname) }}
                {{ form_widget(form.nickname) }}
                {{ form_errors(form.nickname) }}
            </div>

            <div class="col-span-2 grid grid-cols-2 gap-4" data-controller="imperial-date">
                <div>
                    {{ form_label(form.birthDate) }}
                    {{ form_widget(form.birthDate.display, { attr: {'data-imperial-date-prev-icon': '«', 'data-imperial-date-next-icon': '»'} }) }}
                    {{ form_widget(form.birthDate.year) }}
                    {{ form_widget(form.birthDate.day) }}
                    {{ form_errors(form.birthDate.display) }}
                </div>
                <div>
                    {{ form_label(form.birthWorld) }}
                    {{ form_widget(form.birthWorld) }}
                    {{ form_errors(form.birthWorld) }}
                </div>
            </div>

            <div class="col-span-2">
                <div class="alert alert-info alert-outline shadow-sm mt-2">
                    <span class="flex items-center justify-center animate-spin-slow">
                        {% include 'icons/radar.html.twig' %}
                    </span>
                    <div class="text-sm text-slate-200">
                        <span class="block">Select a campaign to establish a secure link to the fleet registry and reveal available ships.</span>
                        <span class="block opacity-80">This is a navigation filter only—if no ship is selected, the campaign choice is ignored and no assignment will be recorded.</span>
                        <span class="block opacity-80">The crew record will still be saved, ready for a future assignment.</span>
                    </div>
                </div>
            </div>

            <div id="crew_roles_{{ crew.id }}" class="col-span-2 grid grid-cols-2 gap-4"
                data-controller="campaign-asset role-selector asset-roles-toggle"
                data-action="show->role-selector#prepareSelection close->role-selector#resetSelection cancel->role-selector#resetSelection">
                <div>
                    {{ form_label(form.campaign) }}
                    {{ form_widget(form.campaign) }}
                    {{ form_errors(form.campaign) }}
                </div>
                <div>
                    {{ form_label(form.asset) }}
                    {{ form_widget(form.asset, { attr: {
                        'data-asset-roles-toggle-target': 'assetSelect',
                        'data-action': 'change->asset-roles-toggle#refresh'
                    }}) }}
                    {{ form_errors(form.asset) }}
                </div>
                <div id="asset-roles-wrapper"
                    data-asset-roles-toggle-target="wrapper"
                    class="col-span-2 hidden">
                    <div class="relative overflow-hidden rounded-xl border border-cyan-500/30 bg-gradient-to-r from-slate-900 via-slate-800 to-cyan-900 shadow-lg">
                        <div class="absolute inset-0 opacity-30 mix-blend-screen pointer-events-none"
                             style="background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.25), transparent 35%), radial-gradient(circle at 80% 30%, rgba(14,165,233,0.25), transparent 35%);">
                        </div>
                        <div class="relative p-4 space-y-3">
                            <div class="flex items-start gap-3">
                                <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/40">
                                    {% include 'icons/crew.html.twig' %}
                                </div>
                                <div>
                                    <p class="uppercase text-xs tracking-[0.25em] text-cyan-300/70">Asset roles</p>
                                    <h4 class="font-semibold text-cyan-100 text-lg leading-tight">Bridge manifest</h4>
                                    <p class="text-sm text-cyan-100/80">Toggle assignments as if sealing the crew roster before departure.</p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                {{ form_widget(form.shipRoles, {
                                    attr: {
                                        class: 'hidden',
                                        'data-role-selector-target': 'select',
                                        'data-asset-roles-toggle-target': 'assetRolesSelect',
                                        autocomplete: 'off'
                                    }
                                }) }}
                                <div class="flex items-center gap-2">
                                    {{ form_label(form.shipRoles) }}
                                    <span class="badge badge-outline badge-info badge-xs">tap to toggle</span>
                                </div>
                                <div class="flex flex-wrap gap-2" data-role-selector-target="chips"></div>
                                {{ form_errors(form.shipRoles) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-span-2">
                    <div class="alert alert-info alert-outline shadow-sm mt-2" data-asset-roles-toggle-target="statusHelper">
                        <span class="flex items-center justify-center animate-spin-slow">
                            {% include 'icons/radar.html.twig' %}
                        </span>
                        <div class="text-xs text-slate-200">
                            Select an asset to unlock status tracking and asset roles for this crew member.
                        </div>
                    </div>
                </div>

                <div class="col-span-2 grid grid-cols-2 gap-4 items-end" data-controller="crew-status-date" data-asset-roles-toggle-target="statusWrapper">
                    <div class="space-y-1">
                        {{ form_label(form.status) }}
                        {{ form_widget(form.status, { attr: {
                            'data-crew-status-date-target': 'status',
                            'data-asset-roles-toggle-target': 'statusSelect',
                            'data-action': 'change->crew-status-date#toggle'
                        } }) }}
                    </div>
                    {% for row in [
                        {'field': 'activeDate', 'label': 'Active date', 'target': 'active'},
                        {'field': 'onLeaveDate', 'label': 'On leave date', 'target': 'onLeave'},
                        {'field': 'retiredDate', 'label': 'Retired date', 'target': 'retired'},
                        {'field': 'miaDate', 'label': 'MIA date', 'target': 'mia'},
                        {'field': 'deceasedDate', 'label': 'Deceased date', 'target': 'deceased'}
                    ] %}
                        <div data-controller="imperial-date" data-crew-status-date-target="{{ row.target }}" class="hidden space-y-1">
                            {{ form_label(attribute(form, row.field)) }}
                            {{ form_widget(attribute(form, row.field).display, { attr: {'data-imperial-date-prev-icon': '«', 'data-imperial-date-next-icon': '»'} }) }}
                            {{ form_widget(attribute(form, row.field).year) }}
                            {{ form_widget(attribute(form, row.field).day) }}
                            {{ form_errors(attribute(form, row.field).display) }}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="col-span-2">
                {{ form_label(form.background) }}
                {{ form_widget(form.background) }}
                {{ form_errors(form.background) }}
            </div>

        </fieldset>

        <button type="submit"
                class="btn btn-outline btn-primary mt-4 mb-4 mr-4"
                {% if not (crew.id ? can_edit : can_create) %} disabled {% endif %}
        >
            Save
        </button>
        <a href="{{ path('app_crew_index') }}" role="button" class="btn btn-outline btn-default mt-4 mb-4 mr-4">Cancel</a>

        {{ form_end(form, { render_rest: false }) }}

    </div>

{% endblock %}
