{% extends 'base.html.twig' %}

{% set CAN_EDIT = constant('App\\Security\\Voter\\CrewVoter::EDIT') %}
{% set CAN_CREATE = constant('App\\Security\\Voter\\CrewVoter::CREATE') %}
{% set can_edit = is_granted(CAN_EDIT, crew) %}
{% set can_create = is_granted(CAN_CREATE, crew) %}

{% block title %}Nav-Fi - Crew{% endblock %}

{% block pageContent %}

    <div class="flex flex-col items-stretch gap-4"
         data-controller="campaign-asset role-selector asset-roles-toggle"
         data-action="show->role-selector#prepareSelection close->role-selector#resetSelection cancel->role-selector#resetSelection">

        {{ form_start(form) }}

        {{ form_widget(form._token) }}

        <div class="relative overflow-hidden rounded-xl border border-cyan-500/30 bg-gradient-to-r from-slate-900 via-slate-800 to-indigo-900 shadow-lg mb-6">
            <div class="absolute inset-0 opacity-30 mix-blend-screen pointer-events-none"
                 style="background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.25), transparent 35%), radial-gradient(circle at 80% 30%, rgba(99,102,241,0.25), transparent 35%);">
            </div>
            <div class="relative p-4 flex items-start gap-4">
                <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/40">
                    {% include 'icons/crew.html.twig' %}
                </div>
                <div>
                    <p class="uppercase text-[10px] tracking-[0.3em] text-cyan-300/70 font-bold font-orbitron mb-0.5">Personnel File // Service Registry</p>
                    <h3 class="font-bold text-cyan-100 text-2xl leading-tight font-orbitron uppercase">Biometric Data</h3>
                    <p class="text-xs text-cyan-100/60 font-rajdhani tracking-widest uppercase truncate">Identity and origin: every operative in the registry must be uniquely identified.</p>
                </div>
            </div>
        </div>

        <fieldset class="grid grid-cols-2 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-cyan-500/80 uppercase">Service Record</legend>

            {% if crew.id %}
                <div class="col-span-2">
                    <div class="flex items-baseline h-5 mb-1">
                        <label class="block text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Fleet ID // Code</label>
                    </div>
                    <div class="px-3 py-2 rounded bg-slate-950/50 border border-slate-800 font-mono text-cyan-400 text-sm"><b>{{ crew.code }}</b></div>
                </div>
            {% endif %}

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.name, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.name, { attr: { class: 'input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50' } }) }}
                {{ form_errors(form.name) }}
            </div>

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.surname, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.surname, { attr: { class: 'input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50' } }) }}
                {{ form_errors(form.surname) }}
            </div>

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.nickname, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.nickname, { attr: { class: 'input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50' } }) }}
                {{ form_errors(form.nickname) }}
            </div>

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.birthWorld, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.birthWorld, { attr: { class: 'input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50' } }) }}
                {{ form_errors(form.birthWorld) }}
            </div>

            <div class="col-span-1" data-controller="imperial-date">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.birthDate, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.birthDate.display, { attr: { 
                    class: 'input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50', 
                    'data-imperial-date-target': 'display',
                    'data-action': 'click->imperial-date#toggle',
                    'readonly': true,
                    'data-imperial-date-prev-icon': '«', 
                    'data-imperial-date-next-icon': '»'
                } }) }}
                {{ form_widget(form.birthDate.year) }}
                {{ form_widget(form.birthDate.day) }}
                {{ form_errors(form.birthDate.display) }}
            </div>
        </fieldset>

        <fieldset class="grid grid-cols-2 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-amber-500/80 uppercase">Tactical Assignment</legend>

            <div class="col-span-2">
                <div class="alert alert-info alert-outline shadow-sm border-cyan-500/30 bg-cyan-500/5">
                    <div class="animate-spin-slow text-cyan-500">
                        {% include 'icons/radar.html.twig' with { dim: 24 } %}
                    </div>
                    <div class="text-sm text-slate-200 font-rajdhani">
                        <span class="block uppercase tracking-wider font-bold text-cyan-200">Deployment Protocol</span>
                        <span class="block opacity-80">Link human resources to an Asset // Mission to enable deployment tracking.</span>
                    </div>
                </div>
            </div>

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.campaign, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.campaign, { attr: { class: 'select select-bordered w-full bg-slate-950/50 border-slate-700' } }) }}
                {{ form_errors(form.campaign) }}
            </div>

            <div class="col-span-1">
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.asset, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.asset, { attr: {
                    class: 'select select-bordered w-full bg-slate-950/50 border-slate-700',
                    'data-asset-roles-toggle-target': 'assetSelect',
                    'data-action': 'change->asset-roles-toggle#refresh'
                }}) }}
                {{ form_errors(form.asset) }}
            </div>

            <div id="asset-roles-wrapper"
                data-asset-roles-toggle-target="wrapper"
                class="col-span-2 hidden">
                <div class="relative overflow-hidden rounded-xl border border-cyan-500/30 bg-gradient-to-r from-slate-900 via-slate-800 to-cyan-900 shadow-lg mt-2">
                    <div class="absolute inset-0 opacity-30 mix-blend-screen pointer-events-none"
                         style="background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.25), transparent 35%), radial-gradient(circle at 80% 30%, rgba(14,165,233,0.25), transparent 35%);">
                    </div>
                    <div class="relative p-4 space-y-3">
                        <div class="flex items-start gap-3">
                            <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/40">
                                {% include 'icons/crew.html.twig' %}
                            </div>
                            <div>
                                <p class="uppercase text-xs tracking-[0.25em] text-cyan-300/70">Roles Allocation</p>
                                <h4 class="font-semibold text-cyan-100 text-lg leading-tight uppercase font-orbitron">Asset Manifest</h4>
                                <p class="text-xs text-cyan-100/80 font-rajdhani tracking-widest uppercase mt-1">Authorized personnel bridge clearance.</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            {{ form_widget(form.assetRoles, {
                                attr: {
                                    class: 'hidden',
                                    'data-role-selector-target': 'select',
                                    'data-asset-roles-toggle-target': 'assetRolesSelect',
                                    autocomplete: 'off'
                                }
                            }) }}
                            <div class="flex items-baseline justify-between h-5 mb-1">
                                {{ form_label(form.assetRoles, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                                <span class="text-[8px] text-cyan-500/50 uppercase tracking-tighter"><b>[tap to toggle]</b></span>
                            </div>
                            <div class="flex flex-wrap gap-2" data-role-selector-target="chips"></div>
                            {{ form_errors(form.assetRoles) }}
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>

        <fieldset class="grid grid-cols-2 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-6 relative">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-cyan-500/80 uppercase">Duty Status</legend>

            <div class="col-span-2">
                <div class="alert alert-info alert-outline shadow-sm border-cyan-500/30 bg-cyan-500/5 mb-4" data-asset-roles-toggle-target="statusHelper">
                    <div class="animate-spin-slow text-cyan-500">
                        {% include 'icons/radar.html.twig' with { dim: 24 } %}
                    </div>
                    <div class="text-xs text-slate-200 font-rajdhani uppercase tracking-widest font-bold">
                        Select an <span class="text-cyan-400">Asset</span> to authorize status tracking and log service dates.
                    </div>
                </div>
            </div>

            {% set has_asset = crew.asset is not null %}
            <div class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 items-end" 
                 data-controller="crew-status-date" 
                 data-asset-roles-toggle-target="statusWrapper"
                 data-asset-active="{{ has_asset ? 'true' : 'false' }}">
                <div>
                    {% set status_help_id = form.status.vars.id ~ '-help' %}
                    <div class="flex items-baseline justify-between h-5 mb-1">
                        {{ form_label(form.status, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                        <label for="{{ status_help_id }}" class="text-[9px] cursor-pointer text-cyan-500/50 hover:text-cyan-400 transition-colors uppercase tracking-widest"><b>[info]</b></label>
                    </div>
                    {{ form_widget(form.status, { attr: {
                        class: 'select select-bordered w-full bg-slate-950/50 border-slate-700',
                        'data-crew-status-date-target': 'status',
                        'data-asset-roles-toggle-target': 'statusSelect',
                        'data-action': 'change->crew-status-date#toggle'
                    } }) }}
                    {{ form_errors(form.status) }}
                    <input type="checkbox" id="{{ status_help_id }}" class="modal-toggle hidden" />
                    <div class="modal" role="dialog">
                        <div class="modal-box bg-slate-900 border border-slate-700 shadow-2xl">
                            <h3 class="font-bold text-cyan-100 font-orbitron uppercase tracking-widest text-sm mb-4">Tactical Status Protocol</h3>
                            <p class="py-2 text-sm text-slate-300 font-rajdhani">Status changes trigger chronological logging. Ensure the associated date reflects the exact session day when the status was updated.</p>
                            <div class="modal-action">
                                <label for="{{ status_help_id }}" class="btn btn-primary btn-sm btn-outline font-orbitron uppercase text-[10px]">Close</label>
                            </div>
                        </div>
                    </div>
                </div>

                {% for row in [
                    {'field': 'activeDate', 'label': 'Active date', 'target': 'active'},
                    {'field': 'onLeaveDate', 'label': 'On leave date', 'target': 'onLeave'},
                    {'field': 'retiredDate', 'label': 'Retired date', 'target': 'retired'},
                    {'field': 'miaDate', 'label': 'MIA date', 'target': 'mia'},
                    {'field': 'deceasedDate', 'label': 'Deceased date', 'target': 'deceased'}
                ] %}
                    <div data-controller="imperial-date" data-crew-status-date-target="{{ row.target }}" class="hidden">
                        <div class="flex items-baseline h-5 mb-1">
                            {{ form_label(attribute(form, row.field), null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                        </div>
                        {{ form_widget(attribute(form, row.field).display, { attr: { 
                            class: 'input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50', 
                            'data-imperial-date-target': 'display',
                            'data-action': 'click->imperial-date#toggle',
                            'readonly': true,
                            'data-imperial-date-prev-icon': '«', 
                            'data-imperial-date-next-icon': '»'
                        } }) }}
                        {{ form_widget(attribute(form, row.field).year) }}
                        {{ form_widget(attribute(form, row.field).day) }}
                        {{ form_errors(attribute(form, row.field).display) }}
                    </div>
                {% endfor %}
            </div>
        </fieldset>

        <fieldset class="grid grid-cols-1 bg-slate-900/40 border border-slate-800 gap-6 p-6 rounded-xl shadow-inner mb-8 relative">
            <legend class="px-3 py-1 rounded bg-slate-800 border border-slate-700 text-[10px] font-bold font-orbitron tracking-[0.3em] text-slate-400 uppercase">Personnel File</legend>
            <div>
                <div class="flex items-baseline h-5 mb-1">
                    {{ form_label(form.background, null, { label_attr: { class: 'mb-0 text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50' } }) }}
                </div>
                {{ form_widget(form.background, { attr: { class: 'textarea textarea-bordered w-full bg-slate-950/50 border-slate-700 h-32 focus:border-cyan-500/50 font-rajdhani', placeholder: 'Enter tactical dossier / background history...' } }) }}
                {{ form_errors(form.background) }}
            </div>
        </fieldset>

        <div class="flex items-center justify-end gap-3 mb-10">
            <a href="{{ path('app_crew_index') }}" class="btn btn-ghost font-orbitron uppercase text-[10px] tracking-widest text-slate-500 hover:text-slate-300 font-bold">Abort Changes</a>
            <button type="submit"
                    class="btn btn-primary px-8 font-orbitron uppercase text-[10px] tracking-widest font-bold shadow-lg shadow-cyan-500/10"
                    {% if not (crew.id ? can_edit : can_create) %} disabled {% endif %}
            >
                Confirm Enrollment // Commit to Log
            </button>
        </div>

        {{ form_end(form, { render_rest: false }) }}

    </div>

{% endblock %}
