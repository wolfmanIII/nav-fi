{% extends 'base_plain.html.twig' %}

{% block title %}Ship Mortgage Agreement{% endblock %}
{% block stylesheets %}
    <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; }
        .card { border: none; border-radius: 8px; background: #ffffff; }
        .card-body { padding: 10px; }
        .table { width: 100%; border-collapse: collapse; border: 1px solid #d1d5db; }
        .table th, .table td { border: 1px solid #d1d5db; padding: 6px; }
        .table th { text-align: left; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mb-6 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.35rem; }
        .mt-6 { margin-top: 0.75rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .items-start { align-items: flex-start; }
        .sign-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .sign-table td { vertical-align: top; padding: 0.5rem 0; }
        .header-table { width: 100%; border-collapse: collapse; margin-bottom: 0.5rem; }
        .header-table td { vertical-align: middle; }
        .logo { height: 64px; }
        .gap-4 { gap: 0.75rem; }
        .gap-8 { gap: 1rem; }
        .gap-3 { gap: 0.5rem; }
        .text-sm { font-size: 0.9rem; }
        .text-lg { font-size: 1.125rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .card-title { font-weight: 700; }
        .pt-2 { padding-top: 0.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .footer .page:after { content: counter(page); }
        .footer .topage:after { content: counter(pages); }
    </style>
{% endblock %}
{% block javascripts %}{% endblock %}

{% block pageContent %}
    {% set summary = mortgage.calculate() %}
    {% set installments = mortgage.mortgageInstallments %}
    {% set crew = ship.crews %}
    {% set captain = null %}
    {% for member in crew %}
        {% if captain is null and member.isCaptain() %}
            {% set captain = member %}
        {% endif %}
    {% endfor %}

    <div class="mb-6">
        <table class="header-table">
            <tr>
                <td>
                    <img src="{{ absolute_url(asset('img/captain-log-logo.png')) }}" alt="Captain Log" class="logo">
                </td>
                <td class="text-right">
                    <div class="text-2xl font-bold">Ship Mortgage Agreement</div>
                    <div class="text-sm font-bold">Code: {{ mortgage.code }}{% if mortgage.signed %} • Signed{% endif %}</div>
                    <div class="text-sm">Generated on {{ "now"|date('Y-m-d') }}</div>
                </td>
            </tr>
        </table>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">
                Local Law{% if mortgage.localLaw %} - {{ mortgage.localLaw.shortDescription ?? mortgage.localLaw.description }}{% endif %}
            </h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Description</th>
                        <th class="text-left px-2">Disclaimer</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="px-2">{{ mortgage.localLaw ? mortgage.localLaw.description : '—' }}</td>
                        <td class="px-2">{{ mortgage.localLaw ? (mortgage.localLaw.disclaimer ?? '—') : '—' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Overview</h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Status</th>
                        <th class="text-left px-2">Start Day/Year</th>
                        <th class="text-left px-2">Duration</th>
                        <th class="text-left px-2">Monthly total</th>
                        <th class="text-left px-2">Annual total</th>
                        <th class="text-left px-2">Company</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="px-2">{{ mortgage.signed ? 'Signed' : 'Pending' }}</td>
                        <td class="px-2">{{ mortgage.startDay }}/{{ mortgage.startYear }}</td>
                        <td class="px-2">{{ mortgage.interestRate.duration }} years</td>
                        <td class="text-right px-2">{{ summary.total_monthly_payment|number_format(2, ',', '.') }} Cr</td>
                        <td class="text-right px-2">{{ summary.total_annual_payment|number_format(2, ',', '.') }} Cr</td>
                        <td class="px-2">
                            {% if mortgage.company %}
                                {{ mortgage.company.name }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">Vessel</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Name</th>
                            <th class="text-left px-2">Type / Class</th>
                            <th class="text-left px-2">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="px-2">{{ ship.name }}</td>
                            <td class="px-2">{{ ship.type }} / {{ ship.class }}</td>
                            <td class="text-right px-2">{{ ship.price|number_format(2, ',', '.') }} Cr</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">Counterparty</h2>
                {% if mortgage.company %}
                    <table class="table text-sm">
                        <thead>
                            <tr>
                                <th class="text-left px-2">Name</th>
                                <th class="text-left px-2">Role</th>
                                <th class="text-left px-2">Contact</th>
                                <th class="text-left px-2">Sign label</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="px-2">{{ mortgage.company.name }}</td>
                                <td class="px-2">{{ mortgage.company.companyRole.description }}</td>
                                <td class="px-2">{{ mortgage.company.contact ?? '—' }}</td>
                                <td class="px-2">{{ mortgage.company.signLabel ?? '—' }}</td>
                            </tr>
                        </tbody>
                    </table>
                {% else %}
                    <p>Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Terms</h2>
            <table class="table text-sm">
                <thead>
                    <tr>
                        <th class="text-left px-2">Start Day/Year</th>
                        <th class="text-left px-2">Ship Shares</th>
                        <th class="text-left px-2">Advance Payment</th>
                        <th class="text-left px-2">Discount</th>
                        <th class="text-left px-2">Interest</th>
                        <th class="text-left px-2">Insurance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="px-2">{{ mortgage.startDay }}/{{ mortgage.startYear }}</td>
                        <td class="px-2">{{ mortgage.shipShares ?? 0 }}</td>
                        <td class="text-right px-2">{{ mortgage.advancePayment|number_format(2, ',', '.') }} Cr</td>
                        <td class="px-2">{{ mortgage.discount ?? 0 }} %</td>
                        <td class="px-2">
                            {{ mortgage.interestRate.duration }} years,
                            x{{ mortgage.interestRate.priceMultiplier }}/{{ mortgage.interestRate.priceDivider }},
                            {{ mortgage.interestRate.annualInterestRate }}% annual
                        </td>
                        <td class="px-2">
                            {% if mortgage.insurance %}
                                {{ mortgage.insurance.name }} ({{ mortgage.insurance.annualCost }}% ship price)
                            {% else %}
                                None
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Mortgage</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Ship cost</th>
                            <th class="text-left px-2">Monthly</th>
                            <th class="text-left px-2">Annual</th>
                            <th class="text-left px-2">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-right px-2">{{ summary.ship_cost|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.mortgage_monthly|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.mortgage_annual|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.total_mortgage|number_format(2, ',', '.') }} Cr</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Insurance & totals</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Ins. monthly</th>
                            <th class="text-left px-2">Ins. annual</th>
                            <th class="text-left px-2">Total monthly</th>
                            <th class="text-left px-2">Total annual</th>
                            <th class="text-left px-2">Paid (count)</th>
                            <th class="text-left px-2">Paid (Cr)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-right px-2">{{ summary.insurance_monthly|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.insurance_annual|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.total_monthly_payment|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.total_annual_payment|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.installments_paid }}</td>
                            <td class="text-right px-2">{{ summary.total_mortgage_paid|number_format(2, ',', '.') }} Cr</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if installments|length > 0 %}
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Paid installments</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Code</th>
                            <th class="text-left px-2">Day/Year</th>
                            <th class="text-right px-2">Amount (Cr)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inst in installments %}
                            <tr>
                                <td class="px-2">{{ inst.code }}</td>
                                <td class="px-2">{{ inst.paymentDay }}/{{ inst.paymentYear }}</td>
                                <td class="text-right px-2">{{ inst.payment|number_format(2, ',', '.') }} Cr</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    {% if crew|length > 0 %}
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Ship crew</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Name</th>
                            <th class="text-left px-2">Surname</th>
                            <th class="text-left px-2">Nickname</th>
                            <th class="text-left px-2">Roles</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in crew %}
                            <tr>
                                <td class="px-2">{{ member.name }}</td>
                                <td class="px-2">{{ member.surname }}</td>
                                <td class="px-2">{{ member.nickname ?? '-' }}</td>
                                <td class="px-2">
                                    {% for role in member.shipRoles %}
                                        {{ role.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <table class="sign-table mt-6 text-sm">
        <tr>
            <td>
                <div><b>Owner / Operator</b></div>
                <div>
                    {% if captain %}
                        {{ captain.name }} {{ captain.surname }}
                    {% else %}
                        — 
                    {% endif %}
                </div>
            </td>
            <td style="text-align: right;">
                <div><b>Counterparty</b></div>
                {% if mortgage.company %}
                    <div>{{ mortgage.company.signLabel ?? mortgage.company.name }}</div>
                {% else %}
                    <div>_____________________</div>
                {% endif %}
            </td>
        </tr>
    </table>
{% endblock %}
