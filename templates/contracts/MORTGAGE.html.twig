{% extends 'base_plain.html.twig' %}

{% block title %}Ship Mortgage Agreement{% endblock %}
{% block stylesheets %}
    <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; }
        .card { border: none; border-radius: 8px; background: #ffffff; }
        .card-body { padding: 12px; }
        .table { width: 100%; border-collapse: collapse; border: 1px solid #d1d5db; }
        .table th, .table td { border: 1px solid #d1d5db; padding: 8px; }
        .table th { text-align: left; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mb-6 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 0.75rem; }
        .mb-3 { margin-bottom: 0.5rem; }
        .mt-6 { margin-top: 1rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .gap-4 { gap: 0.75rem; }
        .gap-8 { gap: 1rem; }
        .gap-3 { gap: 0.5rem; }
        .text-sm { font-size: 0.9rem; }
        .text-lg { font-size: 1.125rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .card-title { font-weight: 700; }
        .pt-2 { padding-top: 0.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    </style>
{% endblock %}
{% block javascripts %}{% endblock %}

{% block pageContent %}
    {% set summary = mortgage.calculate() %}
    {% set installments = mortgage.mortgageInstallments %}
    {% set crew = ship.crews %}
    {% set captain = null %}
    {% for member in crew %}
        {% if captain is null and member.isCaptain() %}
            {% set captain = member %}
        {% endif %}
    {% endfor %}

    <div class="mb-6">
        <h1 class="text-2xl font-bold">Ship Mortgage Agreement</h1>
        <p class="text-sm opacity-70">Code: {{ mortgage.code }}{% if mortgage.signed %} • Signed{% endif %}</p>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">Vessel</h2>
                <p><b>Name:</b> {{ ship.name }}</p>
                <p><b>Type / Class:</b> {{ ship.type }} / {{ ship.class }}</p>
                <p><b>Price:</b> {{ ship.price|number_format(2, ',', '.') }} Cr</p>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">Counterparty</h2>
                {% if mortgage.company %}
                    <p><b>Name:</b> {{ mortgage.company.name }}</p>
                    <p><b>Role:</b> {{ mortgage.company.companyRole.description }}</p>
                    <p><b>Contact:</b> {{ mortgage.company.contact ?? '—' }}</p>
                    <p><b>Sign label:</b> {{ mortgage.company.signLabel ?? '—' }}</p>
                {% else %}
                    <p>Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Terms</h2>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><b>Start Day/Year:</b> {{ mortgage.startDay }}/{{ mortgage.startYear }}</div>
                <div><b>Ship Shares:</b> {{ mortgage.shipShares ?? 0 }}</div>
                <div><b>Advance Payment:</b> {{ mortgage.advancePayment|number_format(2, ',', '.') }} Cr</div>
                <div><b>Discount:</b> {{ mortgage.discount ?? 0 }} %</div>
                <div><b>Interest:</b>
                    {{ mortgage.interestRate.duration }} years,
                    x{{ mortgage.interestRate.priceMultiplier }}/{{ mortgage.interestRate.priceDivider }},
                    {{ mortgage.interestRate.annualInterestRate }}% annual
                </div>
                <div><b>Insurance:</b>
                    {% if mortgage.insurance %}
                        {{ mortgage.insurance.name }} ({{ mortgage.insurance.annualCost }}% ship price)
                    {% else %}
                        None
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Mortgage</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Ship cost</th>
                            <th class="text-left px-2">Monthly</th>
                            <th class="text-left px-2">Annual</th>
                            <th class="text-left px-2">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-right px-2">{{ summary.ship_cost|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.mortgage_monthly|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.mortgage_annual|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.total_mortgage|number_format(2, ',', '.') }} Cr</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Insurance & totals</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Ins. monthly</th>
                            <th class="text-left px-2">Ins. annual</th>
                            <th class="text-left px-2">Total monthly</th>
                            <th class="text-left px-2">Total annual</th>
                            <th class="text-left px-2">Paid (count)</th>
                            <th class="text-left px-2">Paid (Cr)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-right px-2">{{ summary.insurance_monthly|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.insurance_annual|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.total_monthly_payment|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.total_annual_payment|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right px-2">{{ summary.installments_paid }}</td>
                            <td class="text-right px-2">{{ summary.total_mortgage_paid|number_format(2, ',', '.') }} Cr</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if installments|length > 0 %}
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Paid installments</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Code</th>
                            <th class="text-left px-2">Day/Year</th>
                            <th class="text-right px-2">Amount (Cr)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inst in installments %}
                            <tr>
                                <td class="px-2">{{ inst.code }}</td>
                                <td class="px-2">{{ inst.paymentDay }}/{{ inst.paymentYear }}</td>
                                <td class="text-right px-2">{{ inst.payment|number_format(2, ',', '.') }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    {% if crew|length > 0 %}
        <div class="card mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Ship crew</h2>
                <table class="table text-sm">
                    <thead>
                        <tr>
                            <th class="text-left px-2">Name</th>
                            <th class="text-left px-2">Surname</th>
                            <th class="text-left px-2">Nickname</th>
                            <th class="text-left px-2">Roles</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in crew %}
                            <tr>
                                <td class="px-2">{{ member.name }}</td>
                                <td class="px-2">{{ member.surname }}</td>
                                <td class="px-2">{{ member.nickname ?? '-' }}</td>
                                <td class="px-2">
                                    {% for role in member.shipRoles %}
                                        {{ role.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <div class="grid grid-cols-2 gap-8 mt-6 text-sm">
        <div class="pt-2">
            <div><b>Owner / Operator</b></div>
            <div>
                {% if captain %}
                    {{ captain.name }} {{ captain.surname }}
                {% else %}
                    — 
                {% endif %}
            </div>
        </div>
        <div class="pt-2">
            <div><b>Counterparty</b></div>
            {% if mortgage.company %}
                <div>{{ mortgage.company.signLabel ?? mortgage.company.name }}</div>
            {% else %}
                <div>_____________________</div>
            {% endif %}
        </div>
    </div>
{% endblock %}
