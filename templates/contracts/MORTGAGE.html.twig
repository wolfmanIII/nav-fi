{% extends 'base_plain.html.twig' %}

{% block title %}Ship Mortgage Agreement{% endblock %}
{% block stylesheets %}{% endblock %}
{% block javascripts %}{% endblock %}

{% block pageContent %}
    {% set summary = mortgage.calculate() %}
    {% set installments = mortgage.mortgageInstallments %}
    {% set crew = ship.crews %}

    <div class="mb-6">
        <h1 class="text-2xl font-bold">Ship Mortgage Agreement</h1>
        <p class="text-sm opacity-70">Code: {{ mortgage.code }}{% if mortgage.signed %} • Signed{% endif %}</p>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="card bg-base-200 border border-base-300 shadow-sm">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">Vessel</h2>
                <p><b>Name:</b> {{ ship.name }}</p>
                <p><b>Type / Class:</b> {{ ship.type }} / {{ ship.class }}</p>
                <p><b>Price:</b> {{ ship.price|number_format(2, ',', '.') }} Cr</p>
            </div>
        </div>

        <div class="card bg-base-200 border border-base-300 shadow-sm">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-2">Counterparty</h2>
                {% if mortgage.company %}
                    <p><b>Name:</b> {{ mortgage.company.name }}</p>
                    <p><b>Role:</b> {{ mortgage.company.companyRole.description }} ({{ mortgage.company.companyRole.code }})</p>
                    <p><b>Contact:</b> {{ mortgage.company.contact ?? '—' }}</p>
                    <p><b>Sign label:</b> {{ mortgage.company.signLabel ?? '—' }}</p>
                {% else %}
                    <p>Not specified</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card bg-base-200 border border-base-300 shadow-sm mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-lg mb-2">Terms</h2>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div><b>Start Day/Year:</b> {{ mortgage.startDay }}/{{ mortgage.startYear }}</div>
                <div><b>Ship Shares:</b> {{ mortgage.shipShares ?? 0 }}</div>
                <div><b>Advance Payment:</b> {{ mortgage.advancePayment|number_format(2, ',', '.') }} Cr</div>
                <div><b>Discount:</b> {{ mortgage.discount ?? 0 }} %</div>
                <div><b>Interest:</b>
                    {{ mortgage.interestRate.duration }} years,
                    x{{ mortgage.interestRate.priceMultiplier }}/{{ mortgage.interestRate.priceDivider }},
                    {{ mortgage.interestRate.annualInterestRate }}% annual
                </div>
                <div><b>Insurance:</b>
                    {% if mortgage.insurance %}
                        {{ mortgage.insurance.name }} ({{ mortgage.insurance.annualCost }}% ship price)
                    {% else %}
                        None
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="card bg-base-200 border border-base-300 shadow-sm">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Mortgage</h2>
                <table class="table w-full text-sm border border-base-300">
                    <thead>
                        <tr>
                            <th class="text-left border border-base-300 px-2">Ship cost</th>
                            <th class="text-left border border-base-300 px-2">Monthly</th>
                            <th class="text-left border border-base-300 px-2">Annual</th>
                            <th class="text-left border border-base-300 px-2">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-right border border-base-300 px-2">{{ summary.ship_cost|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.mortgage_monthly|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.mortgage_annual|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.total_mortgage|number_format(2, ',', '.') }} Cr</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card bg-base-200 border border-base-300 shadow-sm">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Insurance & totals</h2>
                <table class="table w-full text-sm border border-base-300">
                    <thead>
                        <tr>
                            <th class="text-left border border-base-300 px-2">Ins. monthly</th>
                            <th class="text-left border border-base-300 px-2">Ins. annual</th>
                            <th class="text-left border border-base-300 px-2">Total monthly</th>
                            <th class="text-left border border-base-300 px-2">Total annual</th>
                            <th class="text-left border border-base-300 px-2">Paid (count)</th>
                            <th class="text-left border border-base-300 px-2">Paid (Cr)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-right border border-base-300 px-2">{{ summary.insurance_monthly|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.insurance_annual|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.total_monthly_payment|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.total_annual_payment|number_format(2, ',', '.') }} Cr</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.installments_paid }}</td>
                            <td class="text-right border border-base-300 px-2">{{ summary.total_mortgage_paid|number_format(2, ',', '.') }} Cr</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if installments|length > 0 %}
        <div class="card bg-base-200 border border-base-300 shadow-sm mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Paid installments</h2>
                <table class="table w-full text-sm border border-base-300">
                    <thead>
                        <tr>
                            <th class="text-left border border-base-300 px-2">Code</th>
                            <th class="text-left border border-base-300 px-2">Day/Year</th>
                            <th class="text-right border border-base-300 px-2">Amount (Cr)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inst in installments %}
                            <tr>
                                <td class="border border-base-300 px-2">{{ inst.code }}</td>
                                <td class="border border-base-300 px-2">{{ inst.paymentDay }}/{{ inst.paymentYear }}</td>
                                <td class="text-right border border-base-300 px-2">{{ inst.payment|number_format(2, ',', '.') }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    {% if crew|length > 0 %}
        <div class="card bg-base-200 border border-base-300 shadow-sm mb-4">
            <div class="card-body p-4">
                <h2 class="card-title text-lg mb-3">Ship crew</h2>
                <table class="table w-full text-sm border border-base-300">
                    <thead>
                        <tr>
                            <th class="text-left border border-base-300 px-2">Name</th>
                            <th class="text-left border border-base-300 px-2">Surname</th>
                            <th class="text-left border border-base-300 px-2">Nickname</th>
                            <th class="text-left border border-base-300 px-2">Roles</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in crew %}
                            <tr>
                                <td class="border border-base-300 px-2">{{ member.name }}</td>
                                <td class="border border-base-300 px-2">{{ member.surname }}</td>
                                <td class="border border-base-300 px-2">{{ member.nickname ?? '-' }}</td>
                                <td class="border border-base-300 px-2">
                                    {% for role in member.shipRoles %}
                                        {{ role.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <div class="grid grid-cols-2 gap-8 mt-6 text-sm">
        <div class="border-t border-base-300 pt-2">
            <div><b>Owner / Operator</b></div>
            <div>{{ user.userIdentifier }}</div>
        </div>
        <div class="border-t border-base-300 pt-2">
            <div><b>Counterparty</b></div>
            {% if mortgage.company %}
                <div>{{ mortgage.company.signLabel ?? mortgage.company.name }}</div>
            {% else %}
                <div>_____________________</div>
            {% endif %}
        </div>
    </div>
{% endblock %}
