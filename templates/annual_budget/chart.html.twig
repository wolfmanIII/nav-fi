{% extends 'base.html.twig' %}

{% block title %}Nav-Fi - Annual Budget Chart{% endblock %}

{% block pageContent %}
    {% import '_tooltip.html.twig' as tooltip %}

    <div class="p-10">
        <div class="relative overflow-hidden rounded-xl border border-indigo-500/30 bg-gradient-to-r from-slate-900 via-slate-800 to-indigo-900 shadow-lg mb-6">
            <div class="absolute inset-0 opacity-30 mix-blend-screen pointer-events-none"
                 style="background: radial-gradient(circle at 20% 20%, rgba(99,102,241,0.25), transparent 35%), radial-gradient(circle at 80% 30%, rgba(79,70,229,0.25), transparent 35%);">
            </div>
            <div class="relative p-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div class="flex items-start gap-4">
                    <div class="p-3 rounded-lg bg-indigo-500/10 border border-indigo-400/40 text-indigo-400">
                        {% include 'icons/annual-budget.html.twig' %}
                    </div>
                    <div>
                        <p class="uppercase text-xs tracking-[0.25em] text-indigo-300/70">Budget Analysis</p>
                        <h1 class="text-3xl font-semibold text-indigo-100 leading-tight">{{ budget.asset.name }}</h1>
                        <p class="text-sm text-indigo-100/80 font-mono">{{ budget.startYear }} — <span class="text-indigo-300">{{ budget.note|default('Budget') }}</span></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    {{ tooltip.link('Return to budget list', 'Back', 'icons/action-back.html.twig', path('app_annual_budget_index'), { position: 'tooltip-left', dim: 20, linkClass: 'btn btn-square btn-ghost text-slate-400 hover:bg-slate-800' }) }}
                    {{ tooltip.link('Edit budget parameters', 'Edit', 'icons/action-edit.html.twig', path('app_annual_budget_edit', {id: budget.id}), { position: 'tooltip-left', dim: 20, linkClass: 'btn btn-outline btn-primary btn-sm' }) }}
                </div>
            </div>
        </div>

        <div class="alert alert-info alert-outline shadow-sm mb-6 mt-6">
            <div class="flex items-center gap-3">
                {% include 'icons/annual-budget.html.twig' %}
                <div>
                    <h3 class="font-semibold">Credits on this budget window</h3>
                    <p class="text-sm opacity-80">
                        Incoming vs outgoing credits for this ship between {{ (budget.startDay is not null and budget.startYear is not null) ? (budget.startDay|imperial_date(budget.startYear)) : '—' }} and {{ (budget.endDay is not null and budget.endYear is not null) ? (budget.endDay|imperial_date(budget.endYear)) : '—' }}.
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-base-100 border border-base-300 rounded-xl p-4">
            <canvas id="budgetChart" height="120"></canvas>
        </div>
    </div>

    <script>
        (() => {
            const labels = {{ labels|json_encode|raw }};
            const incomeData = {{ incomeSeries|json_encode|raw }};
            const costData = {{ costSeries|json_encode|raw }};

            function renderBudgetChart() {
                const canvas = document.getElementById('budgetChart');
                if (!canvas || !window.Chart) {
                    return;
                }

                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34,197,94,0.15)',
                                tension: 0.2,
                                fill: true,
                            },
                            {
                                label: 'Costs',
                                data: costData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239,68,68,0.15)',
                                tension: 0.2,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        stacked: false,
                        plugins: {
                            legend: { labels: { color: '#cbd5e1' } },
                        },
                        scales: {
                            x: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            },
                            y: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            }
                        }
                    }
                });
            }

            function ensureChartJsAndRender() {
                if (window.Chart) {
                    renderBudgetChart();
                    return;
                }

                let script = document.querySelector('script[data-chartjs]');
                if (!script) {
                    script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.async = true;
                    script.dataset.chartjs = 'true';
                    document.head.appendChild(script);
                }

                script.addEventListener('load', () => {
                    renderBudgetChart();
                }, { once: true });
            }

            const triggerRender = () => ensureChartJsAndRender();

            if (document.readyState === 'loading') {
                document.addEventListener('turbo:load', triggerRender, { once: true });
                document.addEventListener('DOMContentLoaded', triggerRender, { once: true });
            } else {
                triggerRender();
            }
        })();
    </script>
{% endblock %}
