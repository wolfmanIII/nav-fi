{% extends 'base.html.twig' %}

{% block title %}Nav-Fi&sup3; - Annual Budget Chart{% endblock %}

{% block pageContent %}
    {% import '_tooltip.html.twig' as tooltip %}

    <div class="p-10">
    {% embed 'components/_hero_header.html.twig' with {
        icon: 'icons/annual-budget.html.twig',
        theme: 'indigo',
        subheader: 'Budget Analysis',
        title: budget.asset.name,
        titleSuffix: '// ' ~ budget.startYear ~ ' — ' ~ (budget.note|default('Budget')),
        description: 'Incoming vs outgoing credits analysis for this asset.',
        asset: budget.asset
    } %}
        {% import '_tooltip.html.twig' as tooltip %}
        {% block actions %}
            {{ tooltip.link('Return to budget list', 'Back', 'icons/action-back.html.twig', path('app_annual_budget_index'), { dim: 16, linkClass: 'btn btn-outline btn-sm gap-2 font-orbitron text-[10px] tracking-widest uppercase', position: 'tooltip-left' }) }}
            {{ tooltip.link('Edit budget parameters', 'Edit', 'icons/action-edit.html.twig', path('app_annual_budget_edit', {id: budget.id}), { dim: 16, linkClass: 'btn btn-outline btn-primary btn-sm gap-2 font-orbitron text-[10px] tracking-widest uppercase shadow-lg shadow-indigo-500/20', position: 'tooltip-left' }) }}
        {% endblock %}
    {% endembed %}

        <div class="alert alert-info alert-outline shadow-sm mb-6 mt-6">
            <div class="flex items-center gap-3">
                {% include 'icons/annual-budget.html.twig' %}
                <div>
                    <h3 class="font-semibold">Credits on this budget window</h3>
                    <p class="text-sm opacity-80">
                        Incoming vs outgoing credits between {{ (budget.startDay is not null) ? (budget.startDay|imperial_date(budget.startYear)) : '—' }} and {{ (budget.endDay is not null) ? (budget.endDay|imperial_date(budget.endYear)) : '—' }}.
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-base-100 border border-base-300 rounded-xl p-4">
            <canvas id="budgetChart" height="120"></canvas>
        </div>
    </div>

    <script>
        (() => {
            const labels = {{ labels|json_encode|raw }};
            const incomeData = {{ incomeSeries|json_encode|raw }};
            const costData = {{ costSeries|json_encode|raw }};

            function renderBudgetChart() {
                const canvas = document.getElementById('budgetChart');
                if (!canvas || !window.Chart) {
                    return;
                }

                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Incoming Credits',
                                data: incomeData,
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34,197,94,0.15)',
                                tension: 0.2,
                                fill: true,
                            },
                            {
                                label: 'Outgoing Credits',
                                data: costData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239,68,68,0.15)',
                                tension: 0.2,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        stacked: false,
                        plugins: {
                            legend: { labels: { color: '#cbd5e1' } },
                        },
                        scales: {
                            x: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            },
                            y: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            }
                        }
                    }
                });
            }

            function ensureChartJsAndRender() {
                if (window.Chart) {
                    renderBudgetChart();
                    return;
                }

                let script = document.querySelector('script[data-chartjs]');
                if (!script) {
                    script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.async = true;
                    script.dataset.chartjs = 'true';
                    document.head.appendChild(script);
                }

                script.addEventListener('load', () => {
                    renderBudgetChart();
                }, { once: true });
            }

            const triggerRender = () => ensureChartJsAndRender();

            if (document.readyState === 'loading') {
                document.addEventListener('turbo:load', triggerRender, { once: true });
                document.addEventListener('DOMContentLoaded', triggerRender, { once: true });
            } else {
                triggerRender();
            }
        })();
    </script>
{% endblock %}
