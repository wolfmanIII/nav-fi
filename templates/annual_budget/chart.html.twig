{% extends 'base.html.twig' %}

{% block title %}Captain Log - Annual Budget Chart{% endblock %}

{% block pageContent %}
    <div class="p-10">
        <header class="prose">
            <h1>Annual Budget â€“ {{ budget.ship.name }}</h1>
        </header>

        <div class="alert alert-info alert-outline shadow-sm mb-6">
            <div>
                <h3 class="font-semibold">Credits on this budget window</h3>
                <p class="text-sm opacity-80">
                    Incoming vs outgoing credits for this ship between {{ budget.startDay }}/{{ budget.startYear }} and {{ budget.endDay }}/{{ budget.endYear }}.
                </p>
            </div>
        </div>

        <div class="bg-base-100 border border-base-300 rounded-xl p-4">
            <canvas id="budgetChart" height="120"></canvas>
        </div>
    </div>

    <script>
        (() => {
            const labels = {{ labels|json_encode|raw }};
            const incomeData = {{ incomeSeries|json_encode|raw }};
            const costData = {{ costSeries|json_encode|raw }};

            function renderBudgetChart() {
                const canvas = document.getElementById('budgetChart');
                if (!canvas || !window.Chart) {
                    return;
                }

                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34,197,94,0.15)',
                                tension: 0.2,
                                fill: true,
                            },
                            {
                                label: 'Costs',
                                data: costData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239,68,68,0.15)',
                                tension: 0.2,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        stacked: false,
                        plugins: {
                            legend: { labels: { color: '#cbd5e1' } },
                        },
                        scales: {
                            x: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            },
                            y: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            }
                        }
                    }
                });
            }

            function ensureChartJsAndRender() {
                if (window.Chart) {
                    renderBudgetChart();
                    return;
                }

                let script = document.querySelector('script[data-chartjs]');
                if (!script) {
                    script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.async = true;
                    script.dataset.chartjs = 'true';
                    document.head.appendChild(script);
                }

                script.addEventListener('load', () => {
                    renderBudgetChart();
                }, { once: true });
            }

            const triggerRender = () => ensureChartJsAndRender();

            if (document.readyState === 'loading') {
                document.addEventListener('turbo:load', triggerRender, { once: true });
                document.addEventListener('DOMContentLoaded', triggerRender, { once: true });
            } else {
                triggerRender();
            }
        })();
    </script>
{% endblock %}
