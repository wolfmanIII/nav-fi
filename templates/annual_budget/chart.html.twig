{% extends 'base.html.twig' %}

{% block title %}Nav-Fi&sup3; - Annual Budget Chart{% endblock %}

{% block pageContent %}
    {% import '_tooltip.html.twig' as tooltip %}

    <div class="p-10">
        <div class="relative overflow-hidden rounded-2xl bg-slate-950 border border-slate-800 p-6 shadow-lg mb-6">
             <div class="absolute top-0 right-0 p-4 opacity-10">
                {% include 'icons/annual-budget.html.twig' with { dim: 128, class: 'text-indigo-500' } %}
            </div>
            <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                     <div class="flex items-center gap-2 text-indigo-500/80 mb-1">
                        {% include 'icons/annual-budget.html.twig' with { dim: 16 } %}
                        <p class="text-xs uppercase tracking-[0.3em] font-orbitron font-bold">Budget Analysis</p>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight flex items-center gap-3 font-orbitron">
                        {{ budget.asset.name|upper }}
                        <span class="text-xs align-top opacity-50 font-mono pt-2 normal-case tracking-normal text-slate-400">
                             // {{ budget.startYear }} — {{ budget.note|default('Budget') }}
                        </span>
                    </h1>
                    <p class="text-xs text-slate-500 font-mono uppercase tracking-wider mt-1">
                         Incoming vs outgoing credits analysis for this asset.
                    </p>
                </div>
                <div class="flex gap-2">
                    {{ tooltip.link('Return to budget list', 'Back', 'icons/action-back.html.twig', path('app_annual_budget_index'), { position: 'tooltip-left', dim: 20, linkClass: 'btn btn-square btn-ghost text-slate-400 hover:bg-slate-800' }) }}
                    {{ tooltip.link('Edit budget parameters', 'Edit', 'icons/action-edit.html.twig', path('app_annual_budget_edit', {id: budget.id}), { position: 'tooltip-left', dim: 20, linkClass: 'btn btn-outline btn-primary btn-sm' }) }}
                </div>
            </div>
        </div>

        <div class="alert alert-info alert-outline shadow-sm mb-6 mt-6">
            <div class="flex items-center gap-3">
                {% include 'icons/annual-budget.html.twig' %}
                <div>
                    <h3 class="font-semibold">Credits on this budget window</h3>
                    <p class="text-sm opacity-80">
                        Incoming vs outgoing credits- **Behavior**: The Asset dropdown is disabled until a Mission is chosen, preventing Mortgages from being created without a proper Campaign context.

# Route Optimization

## Scalable TSP Algorithm
- **Problem**: The original Traveling Salesperson Problem (TSP) implementation used brute force ($O(N!)$), which could crash or hang the server with more than ~8-9 waypoints.
- **Solution**: Implemented a **Hybrid Algorithm** in `RouteOptimizationService`:
    - **Brute Force (Exact)**: Still used for $N \le 6$ destinations to guarantee the mathematically optimal route for small sets.
    - **Nearest Neighbor (Heuristic)**: Used for $N > 6$ destinations to ensure fast results ($O(N^2)$) as lists grow.
- **Verification**:
    - Verified existing tests pass.
    - Added `testOptimizeMultiStopRouteHeuristic` for $N = 7$ destinations, confirming correct pathing and performance. null) ? (budget.startDay|imperial_date(budget.startYear)) : '—' }} and {{ (budget.endDay is not null and budget.endYear is not null) ? (budget.endDay|imperial_date(budget.endYear)) : '—' }}.
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-base-100 border border-base-300 rounded-xl p-4">
            <canvas id="budgetChart" height="120"></canvas>
        </div>
    </div>

    <script>
        (() => {
            const labels = {{ labels|json_encode|raw }};
            const incomeData = {{ incomeSeries|json_encode|raw }};
            const costData = {{ costSeries|json_encode|raw }};

            function renderBudgetChart() {
                const canvas = document.getElementById('budgetChart');
                if (!canvas || !window.Chart) {
                    return;
                }

                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34,197,94,0.15)',
                                tension: 0.2,
                                fill: true,
                            },
                            {
                                label: 'Costs',
                                data: costData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239,68,68,0.15)',
                                tension: 0.2,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        stacked: false,
                        plugins: {
                            legend: { labels: { color: '#cbd5e1' } },
                        },
                        scales: {
                            x: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            },
                            y: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: 'rgba(148,163,184,0.2)' }
                            }
                        }
                    }
                });
            }

            function ensureChartJsAndRender() {
                if (window.Chart) {
                    renderBudgetChart();
                    return;
                }

                let script = document.querySelector('script[data-chartjs]');
                if (!script) {
                    script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.async = true;
                    script.dataset.chartjs = 'true';
                    document.head.appendChild(script);
                }

                script.addEventListener('load', () => {
                    renderBudgetChart();
                }, { once: true });
            }

            const triggerRender = () => ensureChartJsAndRender();

            if (document.readyState === 'loading') {
                document.addEventListener('turbo:load', triggerRender, { once: true });
                document.addEventListener('DOMContentLoaded', triggerRender, { once: true });
            } else {
                triggerRender();
            }
        })();
    </script>
{% endblock %}
