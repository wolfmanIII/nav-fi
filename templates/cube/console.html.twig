{% extends 'base.html.twig' %}

{% block layout_class %}bg-scifi-texture{% endblock %}

{% block title %}The Cube // Console{% endblock %}

{% block pageContent %}
<div class="space-y-6" data-controller="cube" data-cube-session-id-value="{{ active_session.id }}">
    
    {# HEADER: Active Session #}
    <div class="relative rounded-2xl bg-slate-950 border border-slate-800 shadow-lg">
        <div class="absolute inset-0 overflow-hidden rounded-2xl pointer-events-none">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                {% include 'icons/cube.html.twig' with { dim: 128, class: 'text-emerald-500' } %}
            </div>
        </div>
        <div class="relative z-10 p-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                 <div class="flex items-center gap-2 text-emerald-400/80 mb-1">
                    {% include 'icons/cube.html.twig' with { dim: 16 } %}
                    <p class="text-xs uppercase tracking-[0.3em] font-orbitron font-bold">UPLINK ESTABLISHED</p>
                </div>
                <h1 class="text-3xl md:text-3xl font-bold text-white tracking-tight flex items-center gap-3">
                    B-Link Console
                </h1>
                <div class="flex items-center gap-4 mt-2">
                    <span class="text-xs font-mono text-slate-400 uppercase">Sector: <span class="text-white">{{ active_session.sector }}</span></span>
                    <span class="text-xs font-mono text-slate-400 uppercase">Origin: <span class="text-white">{{ active_session.originHex }}</span></span>
                    <span class="text-xs font-mono text-slate-400 uppercase">Seed: <span class="text-emerald-500">{{ active_session.seed }}</span></span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                 <a href="{{ path('app_cube_index') }}" class="btn btn-sm btn-outline border-slate-700 text-slate-400 hover:text-white hover:border-slate-500 uppercase font-orbitron tracking-widest text-[10px] gap-2">
                    {% include 'icons/disconnect.html.twig' with { dim: 14 } %}
                    Disconnect
                </a>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-280px)] min-h-[500px]">
        
        <!-- LEFT: The Stream (Generator) -->
        <div class="flex flex-col h-full rounded-2xl bg-slate-900/50 border border-slate-800 relative overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center backdrop-blur-sm">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-xs font-bold text-slate-300 font-orbitron uppercase tracking-widest">Input Stream</span>
                </div>
            </div>
            
            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900" id="stream-container">
                <!-- Stream Cards injected here by JS -->
                <div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50 gap-2">
                    <div class="animate-spin-slow">{% include 'icons/radar.html.twig' with { dim: 32 } %}</div>
                    <span class="text-xs font-mono uppercase tracking-widest">Waiting for scan sequence...</span>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="p-4 border-t border-slate-800 bg-slate-950/50 backdrop-blur-sm flex gap-2">
                <button class="flex-1 bg-slate-800 hover:bg-emerald-900/30 border border-slate-700 hover:border-emerald-500/50 text-slate-300 hover:text-emerald-400 font-bold py-2 px-4 rounded transition-all font-orbitron uppercase tracking-widest text-[10px] flex items-center justify-center gap-2" data-action="cube#generate">
                    {% include 'icons/radar.html.twig' with { dim: 12 } %}
                    Scan Network
                </button>
            </div>
        </div>

        <!-- RIGHT: The Storage (Saved) -->
        <div class="flex flex-col h-full rounded-2xl bg-slate-900/50 border border-slate-800 relative overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center backdrop-blur-sm">
                <div class="flex items-center gap-2">
                    {% include 'icons/cube.html.twig' with { dim: 16, class: 'text-amber-500' } %}
                    <span class="text-xs font-bold text-slate-300 font-orbitron uppercase tracking-widest">Contract Storage</span>
                </div>
                <span class="text-[10px] font-mono text-slate-500 uppercase">{{ active_session.opportunities|length }} ITEMS STORED</span>
            </div>
            
            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900" id="storage-container">
                {% for opp in active_session.opportunities %}
                    <div class="card relative bg-slate-950 border border-slate-800 rounded-xl overflow-hidden hover:border-amber-500/40 transition-all group duration-300 shadow-lg">
                        <div class="absolute inset-0 bg-amber-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-amber-500/50 rounded-l-lg z-20"></div>
                        
                        <div class="p-4 relative z-10">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider bg-slate-900 border border-slate-700 text-slate-300">{{ opp.data.type }}</span>
                                    {% if opp.data.details.difficulty is defined %}
                                        {% set diff = opp.data.details.difficulty %}
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider 
                                            {{ diff == 'Black Ops' ? 'bg-rose-950 text-rose-500 border-rose-900' : 
                                               (diff == 'Hazardous' ? 'bg-amber-950 text-amber-500 border-amber-900' : 'bg-emerald-950 text-emerald-500 border-emerald-900') }} border">
                                            {{ diff }}
                                        </span>
                                    {% endif %}
                                    <span class="text-[10px] font-mono text-amber-400">{{ opp.data.distance > 0 ? (opp.data.distance ~ ' PC') : 'LOCAL' }}</span>
                                </div>
                                <div class="text-right leading-none">
                                    <div class="text-lg font-bold font-mono text-emerald-400 drop-shadow-[0_0_5px_rgba(16,185,129,0.5)]">{{ opp.amount|format_number({ min_fraction_digit: 0, max_fraction_digit: 0 }, 'decimal', 'default', app.request.locale) }}</div>
                                    <div class="text-[9px] text-slate-600 uppercase tracking-widest font-bold">Credits</div>
                                </div>
                            </div>
                            
                            <a href="{{ path('app_cube_contract_show', {id: opp.id}) }}" class="block group/title mb-2">
                                <h3 class="font-bold text-sm text-amber-100 uppercase font-rajdhani tracking-wide group-hover/title:text-cyan-400 transition-colors">{{ opp.summary }}</h3>
                            </a>
                            
                            <!-- Narrative Block -->
                            {% if opp.data.details.briefing is defined %}
                                <div class="space-y-2 mb-3">
                                    <div class="text-[11px] text-cyan-100/80 font-mono italic leading-relaxed border-l-2 border-amber-500/30 pl-2 py-1 bg-amber-500/5 rounded-r">
                                        {{ opp.data.details.briefing }}
                                    </div>
                                    {% if opp.data.details.twist is defined and opp.data.details.twist != 'None' %}
                                        <div class="text-[10px] text-rose-400 font-mono font-bold bg-rose-500/10 px-2 py-1 rounded border border-rose-500/20">
                                            TWIST: <span class="glitch-text">{{ opp.data.details.twist }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}

                            <!-- Route Block -->
                            <div class="flex items-center gap-2 mb-3 text-[10px] font-mono uppercase tracking-widest bg-slate-900/50 p-2 rounded border border-slate-800/50">
                                <span class="text-slate-600">FROM</span>
                                <span class="text-slate-300">{{ opp.data.details.origin|default('Unknown') }}</span>
                                <span class="text-amber-500 font-bold px-1">&rarr;</span>
                                <span class="text-slate-600">TO</span>
                                <span class="text-cyan-400">{{ opp.data.details.destination|default('Unknown') }}</span>
                            </div>

                            <!-- Status Badge -->
                            {% if opp.status == 'CONVERTED' or opp.status == 'ACCEPTED' %}
                                <div class="mb-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider bg-emerald-950 text-emerald-400 border border-emerald-900 shadow-[0_0_8px_rgba(16,185,129,0.2)]">
                                        Contract Accepted
                                    </span>
                                </div>
                            {% endif %}

                            <div class="text-[10px] text-slate-500 font-mono border-t border-slate-800 pt-2 line-clamp-1">
                                {% set internals = ['origin', 'destination', 'dest_hex', 'dest_dist', 'difficulty', 'mission_type', 'twist', 'tier', 'briefing', 'patron', 'variables', 'start_day', 'start_year'] %}
                                {% for key, val in opp.data.details %}
                                    {% if key not in internals %}
                                        {{ key|replace({'_': ' '}) }}: {{ val }} {{ not loop.last ? '// ' : '' }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <div class="flex justify-end gap-2 mt-4 pt-2">
                                {% if opp.status != 'CONVERTED' and opp.status != 'ACCEPTED' %}
                                    <button class="px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-rose-400 hover:bg-rose-950/30 transition-all border border-transparent hover:border-rose-500/40" 
                                            data-action="cube#unsave"
                                            data-cube-id-param="{{ opp.id }}">
                                        PURGE
                                    </button>
                                {% else %}
                                     <button class="px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest text-slate-700 cursor-not-allowed" disabled title="Accepted contracts cannot be purged">
                                        LOCKED
                                    </button>
                                {% endif %}
                                <a href="{{ path('app_cube_contract_show', {id: opp.id}) }}" class="px-3 py-1.5 rounded bg-amber-900/20 border border-amber-500/30 text-amber-400 hover:bg-amber-500 hover:text-black text-[10px] font-bold uppercase tracking-widest shadow-[0_0_10px_rgba(245,158,11,0.1)] hover:shadow-[0_0_15px_rgba(245,158,11,0.4)] transition-all flex items-center gap-1">
                                    {% include 'icons/cube.html.twig' with { dim: 10 } %}
                                    View Manifest
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                        <span class="text-xs font-mono uppercase tracking-widest">Storage Empty</span>
                    </div>
                {% endfor %}
            </div>
        </div>

    </div>

</div>

<!-- Template for Stream Item -->
<template id="stream-item-template">
    <div class="card relative bg-slate-950 border border-slate-800 rounded-xl overflow-hidden hover:border-cyan-500/40 transition-all group duration-300 shadow-lg">
        <div class="absolute inset-0 bg-cyan-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
        
        <div class="p-4 relative z-10">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider bg-slate-900 border border-slate-700 text-slate-300" data-slot="type">TYPE</span>
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider hidden" data-slot="difficulty"></span>
                    <span class="text-[10px] font-mono text-cyan-400" data-slot="dist">2 PC</span>
                </div>
                <div class="text-right leading-none">
                    <div class="text-lg font-bold font-mono text-emerald-400 drop-shadow-[0_0_5px_rgba(16,185,129,0.5)]" data-slot="amount">15,000</div>
                    <div class="text-[9px] text-slate-600 uppercase tracking-widest font-bold">Credits</div>
                </div>
            </div>
            
            <h3 class="font-bold text-sm text-white uppercase font-rajdhani tracking-wide mb-2" data-slot="summary">Summary</h3>
            
            <!-- Narrative Block (New) -->
            <div class="space-y-2 mb-3 hidden" data-slot="narrative-block">
                <div class="text-[11px] text-cyan-100/80 font-mono italic leading-relaxed border-l-2 border-cyan-500/30 pl-2 py-1 bg-cyan-500/5 rounded-r" data-slot="briefing"></div>
                <div class="text-[10px] text-rose-400 font-mono font-bold bg-rose-500/10 px-2 py-1 rounded border border-rose-500/20 hidden" data-slot="twist"></div>
            </div>

            <!-- Route Block -->
            <div class="flex items-center gap-2 mb-3 text-[10px] font-mono uppercase tracking-widest bg-slate-900/50 p-2 rounded border border-slate-800/50">
                <span class="text-slate-600">FROM</span>
                <span class="text-slate-300" data-slot="origin">ORIGIN</span>
                <span class="text-cyan-500 font-bold px-1">&rarr;</span>
                <span class="text-slate-600">TO</span>
                <span class="text-cyan-400" data-slot="destination">DESTINATION</span>
            </div>

            <div class="text-[10px] text-slate-500 font-mono border-t border-slate-800 pt-2 line-clamp-1" data-slot="details">Details...</div>
            
            <div class="flex justify-end gap-2 mt-4 pt-2">
                <button class="px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-rose-400 hover:bg-rose-950/30 transition-colors" data-action="cube#discard">
                    Ignore
                </button>
                <button class="px-3 py-1.5 rounded bg-cyan-900/20 border border-cyan-500/30 text-cyan-400 hover:bg-cyan-500 hover:text-black text-[10px] font-bold uppercase tracking-widest shadow-[0_0_10px_rgba(8,145,178,0.2)] hover:shadow-[0_0_15px_rgba(6,182,212,0.5)] transition-all flex items-center gap-1" data-action="cube#save">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Download
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Template for Storage Item -->
<template id="storage-item-template">
    <div class="card relative bg-slate-950 border border-slate-800 rounded-xl overflow-hidden hover:border-amber-500/40 transition-all group duration-300 shadow-lg animate-[fadeIn_0.5s_ease-out]">
        <div class="absolute inset-0 bg-amber-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
        <div class="absolute left-0 top-0 bottom-0 w-1 bg-amber-500/50 rounded-l-lg z-20"></div>
        
        <div class="p-4 relative z-10">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider bg-slate-900 border border-slate-700 text-slate-300" data-slot="type">TYPE</span>
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider hidden" data-slot="difficulty"></span>
                    <span class="text-[10px] font-mono text-amber-400" data-slot="dist">2 PC</span>
                </div>
                <div class="text-right leading-none">
                    <div class="text-lg font-bold font-mono text-emerald-400 drop-shadow-[0_0_5px_rgba(16,185,129,0.5)]" data-slot="amount">15,000</div>
                    <div class="text-[9px] text-slate-600 uppercase tracking-widest font-bold">Credits</div>
                </div>
            </div>
            
            <a href="#" class="block group/title mb-2" data-slot="view-link">
                <h3 class="font-bold text-sm text-amber-100 uppercase font-rajdhani tracking-wide group-hover/title:text-cyan-400 transition-colors" data-slot="summary">Summary</h3>
            </a>
            
            <!-- Narrative Block -->
            <div class="space-y-2 mb-3 hidden" data-slot="narrative-block">
                <div class="text-[11px] text-cyan-100/80 font-mono italic leading-relaxed border-l-2 border-amber-500/30 pl-2 py-1 bg-amber-500/5 rounded-r" data-slot="briefing"></div>
                <div class="text-[10px] text-rose-400 font-mono font-bold bg-rose-500/10 px-2 py-1 rounded border border-rose-500/20 hidden" data-slot="twist"></div>
            </div>

            <!-- Route Block -->
            <div class="flex items-center gap-2 mb-3 text-[10px] font-mono uppercase tracking-widest bg-slate-900/50 p-2 rounded border border-slate-800/50">
                <span class="text-slate-600">FROM</span>
                <span class="text-slate-300" data-slot="origin">ORIGIN</span>
                <span class="text-amber-500 font-bold px-1">&rarr;</span>
                <span class="text-slate-600">TO</span>
                <span class="text-cyan-400" data-slot="destination">DESTINATION</span>
            </div>

            <div class="text-[10px] text-slate-500 font-mono border-t border-slate-800 pt-2 line-clamp-1" data-slot="details">Details...</div>
            
            <div class="flex justify-end gap-2 mt-4 pt-2">
                <button class="px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-rose-400 hover:bg-rose-950/30 transition-all border border-transparent hover:border-rose-500/40" 
                        data-action="cube#unsave"
                        data-slot="unsave-btn">
                    PURGE
                </button>
                <a href="#" class="px-3 py-1.5 rounded bg-amber-900/20 border border-amber-500/30 text-amber-400 hover:bg-amber-500 hover:text-black text-[10px] font-bold uppercase tracking-widest shadow-[0_0_10px_rgba(245,158,11,0.1)] hover:shadow-[0_0_15px_rgba(245,158,11,0.4)] transition-all flex items-center gap-1" data-slot="view-link-btn">
                    {% include 'icons/cube.html.twig' with { dim: 10 } %}
                    View Manifest
                </a>
            </div>
        </div>
    </div>
</template>
{% endblock %}
