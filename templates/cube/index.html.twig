{% extends 'base.html.twig' %}

{% block title %}The Cube // Contract Broker{% endblock %}

{% block pageContent %}
<div class="space-y-6" data-controller="cube" data-cube-session-id-value="{{ active_session ? active_session.id : '' }}">
    
    {# HEADER / STATUS BAR #}
    <div class="relative overflow-hidden rounded-2xl bg-slate-950 border border-slate-800 p-6 shadow-lg">
        <div class="absolute top-0 right-0 p-4 opacity-10">
            {% include 'icons/cube.html.twig' with { dim: 128, class: 'text-cyan-500' } %}
        </div>
        <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                 <div class="flex items-center gap-2 text-cyan-400/80 mb-1">
                    {% include 'icons/cube.html.twig' with { dim: 16 } %}
                    <p class="text-xs uppercase tracking-[0.3em] font-orbitron font-bold">TAS // Datalink</p>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight flex items-center gap-3">
                    The Cube
                    <span class="text-xs align-top opacity-50 font-mono pt-2">v1.0</span>
                </h1>
                <a href="https://travellermap.com" target="_blank" class="flex items-center gap-2 text-xs text-slate-500 hover:text-cyan-400 transition-colors font-mono uppercase tracking-wider mt-1">
                    {% include 'icons/travellermap.html.twig' with { dim: 16 } %}
                    <span>powered by travellermap.com</span>
                </a>
            </div>
            
            {% if active_session %}
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-end">
                    <div class="text-xs text-slate-500 uppercase tracking-widest font-mono mb-1">Active Session</div>
                    <div class="flex items-center gap-4 text-xs font-mono bg-slate-900/50 border border-slate-800 rounded px-3 py-1.5">
                        <span class="text-cyan-400 font-bold">SEED: {{ active_session.seed }}</span>
                        <span class="text-slate-600">|</span>
                        <span class="text-slate-300">{{ active_session.sector }}</span>
                        <span class="text-slate-600">|</span>
                        <span class="text-slate-300">HEX {{ active_session.originHex }}</span>
                    </div>
                </div>
            </div>
            {% elseif draft_sessions|length > 0 %}
            <div class="w-full md:w-auto md:min-w-[340px]">
                <label class="block text-[10px] uppercase tracking-widest text-slate-400 font-bold mb-1 font-orbitron opacity-50">Resume</label>
                <select id="session-select" 
                        class="select select-bordered select-sm w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50 font-mono text-white text-xs"
                        data-controller="tom-select" 
                        data-tom-select-placeholder-value="Select..."
                        data-tom-select-search-value="true"
                        onchange="if(this.value) window.location.href='{{ path('app_cube_index') }}?session_id=' + this.value">
                    <option value="">// RESUME SESSION</option>
                    {% for session in draft_sessions %}
                        <option value="{{ session.id }}">
                            {{ session.sector|slice(0, 12) }} ({{ session.originHex }}) - {{ session.createdAt|date('Y-m-d') }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <div class="flex items-center gap-2 text-amber-500 animate-pulse bg-amber-950/20 px-3 py-1 rounded border border-amber-500/20">
                <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                <span class="text-xs font-mono font-bold tracking-widest uppercase">NO SIGNAL</span>
            </div>
            {% endif %}
        </div>
    </div>

    {% if not active_session %}
        <!-- Setup Form -->
        <!-- Setup Interface (Dual Panel) -->
        <div class="flex items-center justify-center min-h-[500px]">
            <div class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
                
                <!-- LEFT PANEL: Search Terminal (Form) -->
                <div class="card bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 border border-cyan-500/20 shadow-2xl overflow-hidden h-[500px] relative group">
                     <div class="relative flex flex-col gap-6 p-8 h-full">
                        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.1), transparent 40%), radial-gradient(circle at 80% 30%, rgba(94,234,212,0.1), transparent 35%);"></div>
                        
                        <div class="relative flex items-center gap-4 h-12">
                            <div class="p-2 rounded-lg bg-cyan-500/10 border border-cyan-400/40 text-cyan-400 flex items-center justify-center w-12 h-12 flex-shrink-0">
                                {% include 'icons/cube.html.twig' with { dim: 24 } %}
                            </div>
                            <div>
                                <p class="text-lg font-bold text-cyan-100 tracking-tight font-orbitron">THE CUBE // SEARCH</p>
                                <p class="text-[10px] text-cyan-400/60 uppercase tracking-[0.3em] font-mono">Contract Query Protocol</p>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto">
                            <form action="{{ path('app_cube_session_new') }}" method="POST" class="space-y-5">
                                <div>
                                     <div class="flex items-baseline h-5 mb-1">
                                        <label class="text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Active Mission</label>
                                    </div>
                                    <select name="campaign_id" class="select select-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50 font-mono text-white text-xs" required>
                                        <option value="" disabled {{ not campaign ? 'selected' : '' }}>// SELECT MISSION CONTEXT</option>
                                        {% for c in campaigns %}
                                            <option value="{{ c.id }}" {{ campaign and campaign.id == c.id ? 'selected' : '' }}>{{ c.title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div>
                                     <div class="flex items-baseline h-5 mb-1">
                                        <label class="text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Target Sector</label>
                                    </div>
                                    <input type="text" name="sector" class="input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50 font-mono text-white placeholder:text-slate-700" placeholder="e.g. Spinward Marches" required>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                         <div class="flex items-baseline h-5 mb-1">
                                            <label class="text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Origin Hex</label>
                                        </div>
                                        <input type="text" name="hex" class="input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50 font-mono text-white placeholder:text-slate-700" placeholder="1910" required maxlength="4">
                                    </div>
                                    <div>
                                         <div class="flex items-baseline h-5 mb-1">
                                            <label class="text-slate-300 text-[10px] uppercase tracking-widest font-bold font-orbitron opacity-50">Jump Range</label>
                                        </div>
                                        <input type="number" name="range" class="input input-bordered w-full bg-slate-950/50 border-slate-700 focus:border-cyan-500/50 font-mono text-white placeholder:text-slate-700" value="2" min="1" max="6" required>
                                    </div>
                                </div>
            
                                <div class="pt-4">
                                    <button type="submit" class="btn btn-primary w-full px-8 font-orbitron uppercase text-[10px] tracking-widest font-bold shadow-lg shadow-cyan-500/10 hover:shadow-cyan-500/20">
                                        Initialize Cube Link
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: Visual/Animation -->
                <div class="card bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 border border-cyan-500/20 shadow-2xl overflow-hidden h-[500px] relative group hidden md:block">
                    <div class="relative flex flex-col gap-6 p-8 h-full">
                         <div class="absolute inset-0 opacity-10 pointer-events-none" style="background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.1), transparent 40%), radial-gradient(circle at 80% 30%, rgba(94,234,212,0.1), transparent 35%);"></div>
                        
                         <div class="flex-1 border border-cyan-500/10 rounded-lg p-8 font-mono text-xs leading-relaxed relative overflow-hidden flex items-center justify-center bg-black/20">
                            <!-- Visual Centerpiece: Overlay Style -->
                            <div class="flex flex-col items-center gap-4">
                                <!-- Animated radar/scanner -->
                                <div class="relative w-24 h-24">
                                    <div class="absolute inset-0 rounded-full border-2 border-cyan-500/30 animate-ping"></div>
                                    <div class="absolute inset-2 rounded-full border-2 border-cyan-400/50 animate-pulse"></div>
                                    <div class="absolute inset-4 rounded-full bg-gradient-to-br from-cyan-500/20 to-blue-500/20 animate-spin" style="animation-duration: 3s;"></div>
                                    <div class="absolute inset-0 flex items-center justify-center text-cyan-400">
                                        {% include 'icons/radar.html.twig' with { dim: 48, class: 'animate-spin-slow' } %}
                                    </div>
                                </div>
                                
                                <!-- Loading text -->
                                <div class="text-center space-y-2 mt-4">
                                    <div class="font-orbitron uppercase tracking-[0.3em] text-cyan-400 text-lg font-bold animate-pulse">
                                        TAS SYNC
                                    </div>
                                    <div class="font-rajdhani uppercase tracking-[0.2em] text-cyan-300/70 text-sm">
                                        // Awaiting Sector Coordinates
                                    </div>
                                    <div class="flex gap-1 justify-center mt-3">
                                        <div class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse" style="animation-delay: 0s;"></div>
                                        <div class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse" style="animation-delay: 0.2s;"></div>
                                        <div class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse" style="animation-delay: 0.4s;"></div>
                                    </div>
                                </div>
                            </div>

                             <!-- Scanline overlay -->
                            <div class="absolute inset-0 bg-[linear-gradient(transparent_50%,rgba(0,0,0,0.5)_50%)] bg-[length:100%_4px] pointer-events-none opacity-20"></div>
                        </div>

                         <div class="relative space-y-2 mt-auto text-center">
                            <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">
                                TAS Network Uplink
                            </p>
                            <p class="text-[10px] text-slate-600 leading-relaxed">
                                Provide sector coordinates to triangulate available contracts.
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    {% else %}
        <!-- Main Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-280px)] min-h-[500px]">
            
            <!-- LEFT: The Stream (Generator) -->
            <div class="flex flex-col h-full rounded-2xl bg-slate-900/50 border border-slate-800 relative overflow-hidden">
                <!-- Header -->
                <div class="p-4 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center backdrop-blur-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                        <span class="text-xs font-bold text-slate-300 font-orbitron uppercase tracking-widest">Input Stream</span>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900" id="stream-container">
                    <!-- Stream Cards injected here by JS -->
                    <div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50 gap-2">
                        <div class="animate-spin-slow">{% include 'icons/radar.html.twig' with { dim: 32 } %}</div>
                        <span class="text-xs font-mono uppercase tracking-widest">Waiting for scan sequence...</span>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="p-4 border-t border-slate-800 bg-slate-950/50 backdrop-blur-sm flex gap-2">
                    <button class="flex-1 bg-slate-800 hover:bg-emerald-900/30 border border-slate-700 hover:border-emerald-500/50 text-slate-300 hover:text-emerald-400 font-bold py-2 px-4 rounded transition-all font-orbitron uppercase tracking-widest text-[10px] flex items-center justify-center gap-2" data-action="cube#generate">
                        {% include 'icons/radar.html.twig' with { dim: 12 } %}
                        Scan Network
                    </button>
                    <a href="{{ path('app_cube_index') }}" class="flex-1 bg-slate-800 hover:bg-amber-900/30 border border-slate-700 hover:border-amber-500/50 text-slate-300 hover:text-amber-400 font-bold py-2 px-4 rounded transition-all font-orbitron uppercase tracking-widest text-[10px] flex items-center justify-center gap-2">
                        {% include 'icons/plus.html.twig' with { dim: 12 } %}
                        New Session
                    </a>
                </div>
            </div>

            <!-- RIGHT: The Storage (Saved) -->
            <div class="flex flex-col h-full rounded-2xl bg-slate-900/50 border border-slate-800 relative overflow-hidden">
                <!-- Header -->
                <div class="p-4 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center backdrop-blur-sm">
                    <div class="flex items-center gap-2">
                        {% include 'icons/cube.html.twig' with { dim: 16, class: 'text-amber-500' } %}
                        <span class="text-xs font-bold text-slate-300 font-orbitron uppercase tracking-widest">Contract Storage</span>
                    </div>
                    <span class="text-[10px] font-mono text-slate-500 uppercase">{{ active_session.opportunities|length }} ITEMS STORED</span>
                </div>
                
                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-900" id="storage-container">
                    {% for opp in active_session.opportunities %}
                        <div class="relative bg-slate-950 border border-slate-800 rounded-lg p-4 hover:border-amber-500/30 transition-all group overflow-hidden">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-amber-500/50 rounded-l-lg"></div>
                            <div class="pl-2 flex justify-between items-center gap-4">
                                <a href="{{ path('app_cube_contract_show', {id: opp.id}) }}" class="flex-1 group/title">
                                    <h4 class="text-sm font-bold text-amber-100 font-rajdhani uppercase tracking-wide group-hover/title:text-cyan-400 transition-colors">{{ opp.summary }}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-[10px] font-mono text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded border border-slate-800">{{ opp.data.type }}</span>
                                        <span class="text-xs font-mono text-emerald-400 font-bold">{{ opp.amount|number_format }} Cr</span>
                                    </div>
                                </a>
                                <div class="shrink-0">
                                    <button class="flex items-center gap-1.5 text-[9px] text-slate-400 hover:text-rose-400 font-bold font-orbitron uppercase tracking-widest transition-all border border-slate-800 px-3 py-2 rounded bg-slate-900/80 hover:bg-rose-950/30 hover:border-rose-500/40" 
                                            data-action="cube#unsave"
                                            data-cube-id-param="{{ opp.id }}">
                                        {% include 'icons/radar.html.twig' with { dim: 10, class: 'opacity-70' } %}
                                        <span>UNSAVE</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50">
                            <span class="text-xs font-mono uppercase tracking-widest">Storage Empty</span>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Footer Actions -->
                <div class="p-4 border-t border-slate-800 bg-slate-950/50 backdrop-blur-sm">
                     <button class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 font-bold py-2 px-4 rounded transition-all font-orbitron uppercase tracking-widest text-[10px] hover:text-white">
                        Archive Session & Close Link
                    </button>
                </div>
            </div>

        </div>
    {% endif %}

</div>

<!-- Template for Stream Item -->
<template id="stream-item-template">
    <div class="card relative bg-slate-950 border border-slate-800 rounded-xl overflow-hidden hover:border-cyan-500/40 transition-all group duration-300 shadow-lg">
        <div class="absolute inset-0 bg-cyan-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
        
        <div class="p-4 relative z-10">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold font-mono uppercase tracking-wider bg-slate-900 border border-slate-700 text-slate-300" data-slot="type">TYPE</span>
                    <span class="text-[10px] font-mono text-cyan-400" data-slot="dist">2 PC</span>
                </div>
                <div class="text-right leading-none">
                    <div class="text-lg font-bold font-mono text-emerald-400 drop-shadow-[0_0_5px_rgba(16,185,129,0.5)]" data-slot="amount">15,000</div>
                    <div class="text-[9px] text-slate-600 uppercase tracking-widest font-bold">Credits</div>
                </div>
            </div>
            
            <h3 class="font-bold text-sm text-white uppercase font-rajdhani tracking-wide mb-2" data-slot="summary">Summary</h3>
            <div class="text-xs text-slate-500 font-mono border-t border-slate-800 pt-2" data-slot="details">Details...</div>
            
            <div class="flex justify-end gap-2 mt-4 pt-2">
                <button class="px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest text-rose-400 hover:bg-rose-950/30 hover:text-rose-300 transition-colors" data-action="cube#discard">
                    Discard
                </button>
                <button class="px-3 py-1.5 rounded bg-cyan-600 hover:bg-cyan-500 text-white text-[10px] font-bold uppercase tracking-widest shadow-[0_0_10px_rgba(8,145,178,0.3)] hover:shadow-[0_0_15px_rgba(6,182,212,0.5)] transition-all flex items-center gap-1" data-action="cube#save">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Keep
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Template for Storage Item -->
<template id="storage-item-template">
    <div class="relative bg-slate-950 border border-slate-800 rounded-lg p-4 hover:border-amber-500/30 transition-all group animate-[fadeIn_0.5s_ease-out] overflow-hidden">
        <div class="absolute left-0 top-0 bottom-0 w-1 bg-amber-500/50 rounded-l-lg"></div>
        <div class="pl-2 flex justify-between items-center gap-4">
            <a href="#" class="flex-1 group/title" data-slot="view-link">
                <h4 class="text-sm font-bold text-amber-100 font-rajdhani uppercase tracking-wide group-hover/title:text-cyan-400 transition-colors" data-slot="summary">Summary</h4>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] font-mono text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded border border-slate-800" data-slot="type">TYPE</span>
                    <span class="text-xs font-mono text-emerald-400 font-bold" data-slot="amount">0 Cr</span>
                </div>
            </a>
            <div class="shrink-0">
                <button class="flex items-center gap-1.5 text-[9px] text-slate-400 hover:text-rose-400 font-bold font-orbitron uppercase tracking-widest transition-all border border-slate-800 px-3 py-2 rounded bg-slate-900/80 hover:bg-rose-950/30 hover:border-rose-500/40" 
                        data-action="cube#unsave"
                        data-slot="unsave-btn">
                    {% include 'icons/radar.html.twig' with { dim: 10, class: 'opacity-70' } %}
                    <span>UNSAVE</span>
                </button>
            </div>
        </div>
    </div>
</template>
{% endblock %}
